# ë¯¸ë“¤ì›¨ì–´ ê°€ì´ë“œ

## ê°œìš”

Next.js ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¼ìš°íŠ¸ ë³´í˜¸ ë° ì ‘ê·¼ ì œì–´ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.

**íŒŒì¼ ìœ„ì¹˜:** `middleware.js` (í”„ë¡œì íŠ¸ ë£¨íŠ¸)

---

## ê¸°ë³¸ êµ¬ì¡°

```javascript
import { withAuth } from "next-auth/middleware"
import { NextResponse } from "next/server"

export default withAuth(
  function middleware(req) {
    // ë¯¸ë“¤ì›¨ì–´ ë¡œì§
  },
  {
    callbacks: {
      authorized: ({ req, token }) => {
        // ì¸ì¦ í™•ì¸ ë¡œì§
      }
    },
    pages: {
      signIn: '/sign-in',
    }
  }
)

export const config = {
  matcher: [ ... ]
}
```

---

## withAuth ë¯¸ë“¤ì›¨ì–´

NextAuthì˜ `withAuth` ë˜í¼ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ì¦ ê¸°ëŠ¥ì„ í™•ì¥í•©ë‹ˆë‹¤.

### ì²« ë²ˆì§¸ ì¸ì: middleware í•¨ìˆ˜

ìš”ì²­ì´ ë“¤ì–´ì˜¬ ë•Œë§ˆë‹¤ ì‹¤í–‰ë˜ëŠ” ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜ì…ë‹ˆë‹¤.

```javascript
function middleware(req) {
  const { pathname } = req.nextUrl
  const token = req.nextauth.token

  // ê³µê°œ ê²½ë¡œ ì •ì˜
  const publicPaths = [
    '/',
    '/sign-in',
    '/sign-up',
    '/privacy',
    '/terms',
  ]

  const isPublicPath = publicPaths.includes(pathname)

  // API ê²½ë¡œëŠ” ê° Route Handlerì—ì„œ ì²˜ë¦¬
  if (pathname.startsWith('/api/')) {
    return NextResponse.next()
  }

  // ê³µê°œ ê²½ë¡œëŠ” í•­ìƒ í—ˆìš©
  if (isPublicPath) {
    return NextResponse.next()
  }

  // ê´€ë¦¬ì í˜ì´ì§€ ì ‘ê·¼ ì²´í¬
  if (pathname.startsWith('/admin')) {
    if (!token) {
      return NextResponse.redirect(
        new URL('/sign-in?callbackUrl=' + encodeURIComponent(pathname), req.url)
      )
    }
  }

  // ê³„ì • ìƒíƒœ í™•ì¸
  if (token?.status === 'DELETED') {
    return NextResponse.redirect(new URL('/sign-in?error=account-deleted', req.url))
  }

  if (token?.status === 'SUSPENDED') {
    return NextResponse.redirect(new URL('/sign-in?error=account-suspended', req.url))
  }

  return NextResponse.next()
}
```

### ë‘ ë²ˆì§¸ ì¸ì: ì˜µì…˜

```javascript
{
  callbacks: {
    authorized: ({ req, token }) => {
      const { pathname } = req.nextUrl
      
      // ê³µê°œ ê²½ë¡œëŠ” í† í° ì—†ì´ë„ í—ˆìš©
      const publicPaths = ['/', '/sign-in', '/sign-up', '/privacy', '/terms']
      if (publicPaths.includes(pathname)) {
        return true
      }

      // API ê²½ë¡œëŠ” í•­ìƒ í—ˆìš© (ê° APIì—ì„œ ì²˜ë¦¬)
      if (pathname.startsWith('/api/')) {
        return true
      }

      // ë‚˜ë¨¸ì§€ëŠ” í† í° í•„ìš”
      return !!token
    }
  },
  pages: {
    signIn: '/sign-in',
  }
}
```

---

## ê²½ë¡œ ë¶„ë¥˜

### ê³µê°œ ê²½ë¡œ (Public Paths)

ì¸ì¦ ì—†ì´ ì ‘ê·¼ ê°€ëŠ¥í•œ ê²½ë¡œì…ë‹ˆë‹¤.

```javascript
const publicPaths = [
  '/',           // ëœë”© í˜ì´ì§€
  '/sign-in',    // ë¡œê·¸ì¸
  '/sign-up',    // íšŒì›ê°€ì…
  '/privacy',    // ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨
  '/terms',      // ì´ìš©ì•½ê´€
]
```

### ë³´í˜¸ëœ ê²½ë¡œ (Protected Paths)

ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê²½ë¡œì…ë‹ˆë‹¤.

```javascript
const protectedPaths = [
  '/dashboard',      // ëŒ€ì‹œë³´ë“œ
  '/my-studies',     // ë‚´ ìŠ¤í„°ë””
  '/tasks',          // í•  ì¼
  '/notifications',  // ì•Œë¦¼
  '/me',             // ë§ˆì´í˜ì´ì§€
  '/settings',       // ì„¤ì •
  '/studies/*',      // ìŠ¤í„°ë”” ìƒì„¸
  '/user/*',         // ì‚¬ìš©ì í”„ë¡œí•„
]
```

### ê´€ë¦¬ì ê²½ë¡œ (Admin Paths)

ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•œ ê²½ë¡œì…ë‹ˆë‹¤.

```javascript
// pathname.startsWith('/admin')
const adminPaths = [
  '/admin',          // ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ
  '/admin/users',    // ì‚¬ìš©ì ê´€ë¦¬
  '/admin/studies',  // ìŠ¤í„°ë”” ê´€ë¦¬
  '/admin/reports',  // ì‹ ê³  ê´€ë¦¬
  // ... ê¸°íƒ€ ê´€ë¦¬ì í˜ì´ì§€
]
```

### API ê²½ë¡œ

API ê²½ë¡œëŠ” ë¯¸ë“¤ì›¨ì–´ì—ì„œ í†µê³¼ì‹œí‚¤ê³ , ê° Route Handlerì—ì„œ ì¸ì¦ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.

```javascript
if (pathname.startsWith('/api/')) {
  return NextResponse.next()
}
```

---

## Matcher ì„¤ì •

ë¯¸ë“¤ì›¨ì–´ê°€ ì ìš©ë  ê²½ë¡œë¥¼ ì •ì˜í•©ë‹ˆë‹¤.

```javascript
export const config = {
  matcher: [
    /*
     * Match all request paths except for the ones starting with:
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     * - public files (public folder)
     */
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
}
```

### ì œì™¸ë˜ëŠ” ê²½ë¡œ

| íŒ¨í„´ | ì„¤ëª… |
|------|------|
| `_next/static` | ì •ì  íŒŒì¼ (JS, CSS) |
| `_next/image` | ì´ë¯¸ì§€ ìµœì í™” |
| `favicon.ico` | íŒŒë¹„ì½˜ |
| `*.svg`, `*.png` ë“± | ì´ë¯¸ì§€ íŒŒì¼ |

---

## ì ‘ê·¼ ì œì–´ íë¦„

### ì „ì²´ ì ‘ê·¼ ì œì–´ íë¦„ë„

```
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  HTTP ìš”ì²­   â”‚
                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚    Matcher í™•ì¸       â”‚
                         â”‚  (ì •ì  íŒŒì¼ ì œì™¸?)    â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚                             â”‚
                      â–¼ Yes                         â–¼ No
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚    í†µê³¼ (Pass)   â”‚          â”‚ withAuth ì‹¤í–‰    â”‚
           â”‚  ì •ì  íŒŒì¼ ì²˜ë¦¬  â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
                                                  â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚   authorized ì½œë°±      â”‚
                                    â”‚   (í† í° ê²€ì‚¬)          â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚                                   â”‚
                              â–¼                                   â–¼
                       ê³µê°œ ê²½ë¡œ?                           ë³´í˜¸ëœ ê²½ë¡œ?
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    Yes      â”‚                      â”‚    No       â”‚
                    â”‚             â”‚                      â”‚ (í† í° í•„ìš”) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚                                    â”‚
                           â–¼                                    â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   í†µê³¼ (Pass)    â”‚              â”‚    í† í° ìˆìŒ?        â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                              â”‚
                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                            â”‚                           â”‚
                                            â–¼ No                        â–¼ Yes
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  /sign-inìœ¼ë¡œ         â”‚    â”‚  middleware í•¨ìˆ˜ â”‚
                              â”‚  ë¦¬ë‹¤ì´ë ‰íŠ¸           â”‚    â”‚  ì‹¤í–‰            â”‚
                              â”‚  ?callbackUrl=...     â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
                                                                    â–¼
                                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                    â”‚     ê´€ë¦¬ì ê²½ë¡œ?          â”‚
                                                    â”‚  pathname.startsWith      â”‚
                                                    â”‚  ('/admin')               â”‚
                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                  â”‚
                                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                â”‚                               â”‚
                                                â–¼ Yes                           â–¼ No
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚   í† í° ìˆìŒ?      â”‚          â”‚  ê³„ì • ìƒíƒœ í™•ì¸   â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚                              â”‚
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
                                    â”‚                   â”‚                    â”‚
                                    â–¼ No                â–¼ Yes                â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚                    â”‚
                        â”‚  /sign-inìœ¼ë¡œ     â”‚           â”‚                    â”‚
                        â”‚  ë¦¬ë‹¤ì´ë ‰íŠ¸       â”‚           â–¼                    â–¼
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                 â”‚         ê³„ì • ìƒíƒœ í™•ì¸          â”‚
                                                 â”‚     token.status ê²€ì‚¬          â”‚
                                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                               â”‚
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚                    â”‚                    â”‚
                                          â–¼                    â–¼                    â–¼
                                     DELETED              SUSPENDED             ACTIVE
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ /sign-in?error= â”‚   â”‚ /sign-in?error= â”‚  â”‚  í†µê³¼       â”‚
                              â”‚ account-deleted â”‚   â”‚ account-suspended  â”‚  (Pass)     â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ê²½ë¡œë³„ ì²˜ë¦¬ íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ê²½ë¡œ ë¶„ë¥˜                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                     ê³µê°œ ê²½ë¡œ (Public)                           â”‚    â”‚
â”‚  â”‚                                                                  â”‚    â”‚
â”‚  â”‚    /              /sign-in         /sign-up                      â”‚    â”‚
â”‚  â”‚    â†“              â†“                â†“                             â”‚    â”‚
â”‚  â”‚  [Landing]     [ë¡œê·¸ì¸]         [íšŒì›ê°€ì…]                       â”‚    â”‚
â”‚  â”‚                                                                  â”‚    â”‚
â”‚  â”‚    /privacy       /terms                                         â”‚    â”‚
â”‚  â”‚    â†“              â†“                                              â”‚    â”‚
â”‚  â”‚  [ê°œì¸ì •ë³´]     [ì´ìš©ì•½ê´€]                                       â”‚    â”‚
â”‚  â”‚                                                                  â”‚    â”‚
â”‚  â”‚  â–¶ í† í° ë¶ˆí•„ìš”, ëˆ„êµ¬ë‚˜ ì ‘ê·¼ ê°€ëŠ¥                                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    ë³´í˜¸ëœ ê²½ë¡œ (Protected)                       â”‚    â”‚
â”‚  â”‚                                                                  â”‚    â”‚
â”‚  â”‚    /dashboard      /my-studies      /tasks      /notifications   â”‚    â”‚
â”‚  â”‚    â†“               â†“                â†“           â†“                â”‚    â”‚
â”‚  â”‚  [ëŒ€ì‹œë³´ë“œ]      [ë‚´ ìŠ¤í„°ë””]       [í•  ì¼]    [ì•Œë¦¼]             â”‚    â”‚
â”‚  â”‚                                                                  â”‚    â”‚
â”‚  â”‚    /me             /settings        /studies/*    /user/*        â”‚    â”‚
â”‚  â”‚    â†“               â†“                â†“             â†“              â”‚    â”‚
â”‚  â”‚  [ë§ˆì´í˜ì´ì§€]    [ì„¤ì •]           [ìŠ¤í„°ë””]     [í”„ë¡œí•„]          â”‚    â”‚
â”‚  â”‚                                                                  â”‚    â”‚
â”‚  â”‚  â–¶ í† í° í•„ìš”, ACTIVE ìƒíƒœë§Œ ì ‘ê·¼ ê°€ëŠ¥                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    ê´€ë¦¬ì ê²½ë¡œ (Admin)                           â”‚    â”‚
â”‚  â”‚                                                                  â”‚    â”‚
â”‚  â”‚    /admin           /admin/users     /admin/studies              â”‚    â”‚
â”‚  â”‚    â†“                â†“                â†“                           â”‚    â”‚
â”‚  â”‚  [ëŒ€ì‹œë³´ë“œ]       [ì‚¬ìš©ì ê´€ë¦¬]    [ìŠ¤í„°ë”” ê´€ë¦¬]                  â”‚    â”‚
â”‚  â”‚                                                                  â”‚    â”‚
â”‚  â”‚    /admin/reports   /admin/sanctions                             â”‚    â”‚
â”‚  â”‚    â†“                â†“                                            â”‚    â”‚
â”‚  â”‚  [ì‹ ê³  ê´€ë¦¬]      [ì œì¬ ê´€ë¦¬]                                    â”‚    â”‚
â”‚  â”‚                                                                  â”‚    â”‚
â”‚  â”‚  â–¶ í† í° í•„ìš” + AdminRole í•„ìš” (í˜ì´ì§€ì—ì„œ í™•ì¸)                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                        API ê²½ë¡œ                                  â”‚    â”‚
â”‚  â”‚                                                                  â”‚    â”‚
â”‚  â”‚    /api/auth/*      /api/studies/*    /api/users/*               â”‚    â”‚
â”‚  â”‚    â†“                â†“                 â†“                          â”‚    â”‚
â”‚  â”‚  [ì¸ì¦ API]       [ìŠ¤í„°ë”” API]      [ì‚¬ìš©ì API]                  â”‚    â”‚
â”‚  â”‚                                                                  â”‚    â”‚
â”‚  â”‚  â–¶ ë¯¸ë“¤ì›¨ì–´ í†µê³¼, ê° Route Handlerì—ì„œ requireAuth() ì‚¬ìš©        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### middleware í•¨ìˆ˜ íë¦„

```
í† í° í™•ì¸ â†’ ê´€ë¦¬ì ê²½ë¡œ? â†’ í† í° ì—†ìŒ â†’ ë¡œê·¸ì¸ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                              â†“
                        ê³„ì • ì‚­ì œë¨? â†’ ë¡œê·¸ì¸ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                              â†“
                        ê³„ì • ì •ì§€ë¨? â†’ ë¡œê·¸ì¸ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                              â†“
                        í†µê³¼ (NextResponse.next())
```

---

## ë¦¬ë‹¤ì´ë ‰íŠ¸

### ë¡œê·¸ì¸ ë¦¬ë‹¤ì´ë ‰íŠ¸

```javascript
// ì½œë°± URL í¬í•¨
return NextResponse.redirect(
  new URL('/sign-in?callbackUrl=' + encodeURIComponent(pathname), req.url)
)
```

### ì—ëŸ¬ ë¦¬ë‹¤ì´ë ‰íŠ¸

```javascript
// ì‚­ì œëœ ê³„ì •
return NextResponse.redirect(new URL('/sign-in?error=account-deleted', req.url))

// ì •ì§€ëœ ê³„ì •
return NextResponse.redirect(new URL('/sign-in?error=account-suspended', req.url))
```

---

## í† í° êµ¬ì¡°

`req.nextauth.token`ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œ í† í° ì •ë³´:

```typescript
interface Token {
  id: string
  email: string
  name: string
  role: 'USER' | 'ADMIN'
  status: 'ACTIVE' | 'SUSPENDED' | 'DELETED'
  provider: 'CREDENTIALS' | 'GOOGLE' | 'GITHUB'
  isAdmin: boolean
  adminRole: 'VIEWER' | 'MODERATOR' | 'ADMIN' | 'SUPER_ADMIN' | null
  restrictedActions: string[]
  restrictedUntil: Date | null
}
```

---

## ë¡œê¹…

ê´€ë¦¬ì í˜ì´ì§€ ì ‘ê·¼ ì‹œ ë¡œê·¸ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤:

```javascript
if (pathname.startsWith('/admin')) {
  console.log('ğŸ” [MIDDLEWARE] ê´€ë¦¬ì í˜ì´ì§€ ì ‘ê·¼ ì‹œë„:', {
    pathname,
    userId: token?.id,
    email: token?.email,
    hasToken: !!token
  })
}
```

---

## ì£¼ì˜ì‚¬í•­

### 1. API ê²½ë¡œ ì²˜ë¦¬

API ê²½ë¡œëŠ” ë¯¸ë“¤ì›¨ì–´ì—ì„œ í†µê³¼ì‹œí‚¤ê³ , ê° Route Handlerì—ì„œ `requireAuth()` ë“±ì„ ì‚¬ìš©í•˜ì—¬ ì¸ì¦ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.

```javascript
// ë¯¸ë“¤ì›¨ì–´
if (pathname.startsWith('/api/')) {
  return NextResponse.next()
}

// API Route
import { requireAuth } from '@/lib/auth-helpers'

export async function GET(request) {
  const authResult = await requireAuth()
  if (authResult instanceof NextResponse) {
    return authResult
  }
  // ...
}
```

### 2. ê´€ë¦¬ì ê¶Œí•œ í™•ì¸

ë¯¸ë“¤ì›¨ì–´ì—ì„œëŠ” í† í° ì¡´ì¬ ì—¬ë¶€ë§Œ í™•ì¸í•˜ê³ , ì‹¤ì œ ê´€ë¦¬ì ê¶Œí•œì€ ê° í˜ì´ì§€/APIì—ì„œ í™•ì¸í•©ë‹ˆë‹¤.

```javascript
// ë¯¸ë“¤ì›¨ì–´: í† í° ì¡´ì¬ í™•ì¸ë§Œ
if (pathname.startsWith('/admin') && !token) {
  return NextResponse.redirect(...)
}

// í˜ì´ì§€/API: ì‹¤ì œ ê¶Œí•œ í™•ì¸
const adminRole = await prisma.adminRole.findUnique({
  where: { userId: session.user.id }
})
if (!adminRole) {
  redirect('/unauthorized')
}
```

### 3. ì„±ëŠ¥ ê³ ë ¤

ë¯¸ë“¤ì›¨ì–´ëŠ” ëª¨ë“  ìš”ì²­ì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ, ë¬´ê±°ìš´ DB ì¿¼ë¦¬ëŠ” í”¼í•´ì•¼ í•©ë‹ˆë‹¤.
DB ì ‘ê·¼ì´ í•„ìš”í•œ ê¶Œí•œ í™•ì¸ì€ í˜ì´ì§€/APIì—ì„œ ìˆ˜í–‰í•©ë‹ˆë‹¤.

---

## í…ŒìŠ¤íŠ¸

### ê³µê°œ ê²½ë¡œ ì ‘ê·¼

```bash
# ë¡œê·¸ì¸ ì—†ì´ ì ‘ê·¼ ê°€ëŠ¥í•´ì•¼ í•¨
curl http://localhost:3000/
curl http://localhost:3000/sign-in
curl http://localhost:3000/sign-up
```

### ë³´í˜¸ëœ ê²½ë¡œ ì ‘ê·¼

```bash
# ë¡œê·¸ì¸ ì—†ì´ ì ‘ê·¼ ì‹œ sign-inìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
curl -I http://localhost:3000/dashboard
# Location: /sign-in?callbackUrl=%2Fdashboard
```

### ê´€ë¦¬ì ê²½ë¡œ ì ‘ê·¼

```bash
# ë¡œê·¸ì¸ ì—†ì´ ì ‘ê·¼ ì‹œ sign-inìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
curl -I http://localhost:3000/admin
# Location: /sign-in?callbackUrl=%2Fadmin
```

---

## ê´€ë ¨ íŒŒì¼

- `src/lib/auth.js` - NextAuth ì„¤ì •
- `src/lib/auth-helpers.js` - ì¸ì¦ í—¬í¼ í•¨ìˆ˜
- `src/app/(auth)/sign-in/page.jsx` - ë¡œê·¸ì¸ í˜ì´ì§€

