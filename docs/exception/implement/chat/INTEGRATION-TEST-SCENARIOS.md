# Chat ì˜ì—­ í†µí•© í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

**ì‘ì„±ì¼**: 2025-12-01  
**Phase**: 6.1 - í†µí•© í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤  
**ëª©ì **: Socket + API + UI ì „ì²´ í”Œë¡œìš° ê²€ì¦

---

## ğŸ“‹ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì¤€ë¹„

### 1. ì„œë²„ ì‹¤í–‰
```powershell
# Chat ì„œë²„ ì‹¤í–‰
cd C:\Project\CoUp\coup
npm run dev

# Signaling ì„œë²„ ì‹¤í–‰ (ë³„ë„ í„°ë¯¸ë„)
cd C:\Project\CoUp\signaling-server
npm start
```

### 2. í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì ì¤€ë¹„
- **User A**: ìŠ¤í„°ë”” ë©¤ë²„ (MEMBER ê¶Œí•œ)
- **User B**: ìŠ¤í„°ë”” ë©¤ë²„ (MEMBER ê¶Œí•œ)
- **User C**: ìŠ¤í„°ë”” ê´€ë¦¬ì (ADMIN ê¶Œí•œ)
- **User D**: ë¹„ë©¤ë²„ (ê¶Œí•œ ì—†ìŒ)

### 3. ë¸Œë¼ìš°ì € ì„¤ì •
- Chrome/Edge 2ê°œ ì´ìƒì˜ í”„ë¡œí•„ ë˜ëŠ” ì‹œí¬ë¦¿ ëª¨ë“œ
- ê°œë°œì ë„êµ¬ ì—´ê¸° (F12)
- Console íƒ­ì—ì„œ ë¡œê·¸ í™•ì¸

---

## ğŸ¯ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

## ì‹œë‚˜ë¦¬ì˜¤ 1: ë©”ì‹œì§€ ì†¡ìˆ˜ì‹  í”Œë¡œìš° (ì •ìƒ ì¼€ì´ìŠ¤)

### ëª©í‘œ
Socket ì—°ê²° â†’ ë©”ì‹œì§€ ì „ì†¡ â†’ ì‹¤ì‹œê°„ ìˆ˜ì‹  â†’ ì½ìŒ ì²˜ë¦¬ ì „ì²´ í”Œë¡œìš° ê²€ì¦

### í…ŒìŠ¤íŠ¸ ë‹¨ê³„

#### Step 1: User A - ì±„íŒ…ë°© ì…ì¥
```
1. User A ë¡œê·¸ì¸
2. ìŠ¤í„°ë”” ìƒì„¸ í˜ì´ì§€ ì ‘ì†
3. ì±„íŒ… íƒ­ í´ë¦­
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… Socket ì—°ê²° ì„±ê³µ (`SOCKET_CONNECTED` ë¡œê·¸)
- âœ… ì±„íŒ…ë°© ì°¸ì—¬ (`CHAT_JOINED` ì´ë²¤íŠ¸)
- âœ… ì´ì „ ë©”ì‹œì§€ ë¡œë”© (GET /api/studies/[id]/chat)
- âœ… Connection Banner í‘œì‹œ: "Connected"

**ì˜ˆìƒ Console ë¡œê·¸**:
```javascript
[Socket] Connected to study-chat-{studyId}
[Chat Info] Messages fetched successfully
{
  studyId: '...',
  count: 10,
  hasMore: false
}
```

---

#### Step 2: User B - ë™ì‹œ ì…ì¥
```
1. User B ë¡œê·¸ì¸ (ë³„ë„ ë¸Œë¼ìš°ì €)
2. ë™ì¼ ìŠ¤í„°ë”” ì±„íŒ…ë°© ì ‘ì†
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… User B Socket ì—°ê²° ì„±ê³µ
- âœ… User Aì—ê²Œ "user-joined" ì´ë²¤íŠ¸ ìˆ˜ì‹ 
- âœ… í˜„ì¬ ì ‘ì†ì ìˆ˜ ì—…ë°ì´íŠ¸

---

#### Step 3: User A - ë©”ì‹œì§€ ì „ì†¡
```
1. User A: ì…ë ¥ì°½ì— "ì•ˆë…•í•˜ì„¸ìš”!" ì…ë ¥
2. ì „ì†¡ ë²„íŠ¼ í´ë¦­ ë˜ëŠ” Enter
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
- âœ… ë‚™ê´€ì  ì—…ë°ì´íŠ¸: ë©”ì‹œì§€ ì¦‰ì‹œ í‘œì‹œ (pending ìƒíƒœ)
- âœ… API ìš”ì²­ ì„±ê³µ (POST /api/studies/[id]/chat)
- âœ… Socket ì´ë²¤íŠ¸ ìˆ˜ì‹ : "new-message"
- âœ… User Bì—ê²Œ ì‹¤ì‹œê°„ ë©”ì‹œì§€ ë„ì°©
- âœ… pending â†’ sent ìƒíƒœ ë³€ê²½

**ì˜ˆìƒ User A Console ë¡œê·¸**:
```javascript
[Optimistic] Adding message locally
{
  tempId: 'temp-123',
  content: 'ì•ˆë…•í•˜ì„¸ìš”!'
}
[Chat Info] Message sent successfully
{
  studyId: '...',
  messageId: '...',
  hasFile: false
}
[Socket] Received new-message event
```

**ì˜ˆìƒ User B Console ë¡œê·¸**:
```javascript
[Socket] Received new-message event
{
  id: '...',
  content: 'ì•ˆë…•í•˜ì„¸ìš”!',
  userName: 'User A'
}
```

---

#### Step 4: User B - ì½ìŒ ì²˜ë¦¬
```
1. User Bê°€ ì±„íŒ… í™”ë©´ ë³´ê³  ìˆëŠ” ìƒíƒœ
2. ìë™ìœ¼ë¡œ ì½ìŒ ì²˜ë¦¬ íŠ¸ë¦¬ê±°
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… POST /api/studies/[id]/chat/read í˜¸ì¶œ
- âœ… User Aì—ê²Œ "messages-read" Socket ì´ë²¤íŠ¸ ìˆ˜ì‹ 
- âœ… User A í™”ë©´: ë©”ì‹œì§€ì— "ì½ìŒ" í‘œì‹œ ì—…ë°ì´íŠ¸

**ì˜ˆìƒ User A Console ë¡œê·¸**:
```javascript
[Socket] Received messages-read event
{
  userId: 'user-b-id',
  lastReadMessageId: '...'
}
```

---

#### Step 5: User A - íŒŒì¼ ì²¨ë¶€ ë©”ì‹œì§€
```
1. User A: íŒŒì¼ ì„ íƒ (ì´ë¯¸ì§€ 5MB)
2. "íŒŒì¼ê³¼ í•¨ê»˜ ë©”ì‹œì§€" ì…ë ¥
3. ì „ì†¡
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… íŒŒì¼ í¬ê¸° ê²€ì¦ (10MB ì´í•˜)
- âœ… íŒŒì¼ ì—…ë¡œë“œ ì§„í–‰ í‘œì‹œ
- âœ… ë©”ì‹œì§€ + íŒŒì¼ ë™ì‹œ ì „ì†¡
- âœ… User Bì—ê²Œ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
- âœ… hasFile: true ë¡œê¹…

**ì˜ˆìƒ Console ë¡œê·¸**:
```javascript
[Chat Info] Message sent successfully
{
  studyId: '...',
  messageId: '...',
  hasFile: true,
  fileSize: 5242880
}
```

---

## ì‹œë‚˜ë¦¬ì˜¤ 2: ë©”ì‹œì§€ ìˆ˜ì •/ì‚­ì œ í”Œë¡œìš°

### ëª©í‘œ
ë©”ì‹œì§€ ìˆ˜ì • ë° ì‚­ì œ ì‹œ ê¶Œí•œ ê²€ì¦ ë° ì‹¤ì‹œê°„ ë™ê¸°í™” í™•ì¸

#### Step 1: User A - ìì‹ ì˜ ë©”ì‹œì§€ ìˆ˜ì •
```
1. User A: ìì‹ ì´ ë³´ë‚¸ ë©”ì‹œì§€ì— ë§ˆìš°ìŠ¤ ì˜¤ë²„
2. "ìˆ˜ì •" ë²„íŠ¼ í´ë¦­
3. "ì•ˆë…•í•˜ì„¸ìš”! (ìˆ˜ì •ë¨)" ìœ¼ë¡œ ë³€ê²½
4. ì €ì¥
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… ìˆ˜ì • UI í™œì„±í™” (ì¸ë¼ì¸ í¸ì§‘)
- âœ… PATCH /api/studies/[id]/chat/[messageId] ì„±ê³µ
- âœ… User Bì—ê²Œ "message-edited" Socket ì´ë²¤íŠ¸
- âœ… User B í™”ë©´: ë©”ì‹œì§€ ë‚´ìš© ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸

**ì˜ˆìƒ User A Console ë¡œê·¸**:
```javascript
[Chat Info] Message updated successfully
{
  studyId: '...',
  messageId: '...',
  newContent: 'ì•ˆë…•í•˜ì„¸ìš”! (ìˆ˜ì •ë¨)'
}
```

---

#### Step 2: User B - íƒ€ì¸ ë©”ì‹œì§€ ìˆ˜ì • ì‹œë„ (ê¶Œí•œ ì—†ìŒ)
```
1. User B: User Aì˜ ë©”ì‹œì§€ì— ë§ˆìš°ìŠ¤ ì˜¤ë²„
2. "ìˆ˜ì •" ë²„íŠ¼ì´ ë³´ì´ì§€ ì•Šê±°ë‚˜ ë¹„í™œì„±í™”ë¨
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… UIì—ì„œ ìˆ˜ì • ë²„íŠ¼ ìˆ¨ê¹€/ë¹„í™œì„±í™”
- âœ… ì§ì ‘ API í˜¸ì¶œ ì‹œ: `403 Forbidden` ì‘ë‹µ

**API í…ŒìŠ¤íŠ¸ (cURL)**:
```bash
curl -X PATCH http://localhost:3000/api/studies/{studyId}/chat/{messageId} \
  -H "Cookie: next-auth.session-token={USER_B_TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{"content":"í•´í‚¹ ì‹œë„"}'
```

**ì˜ˆìƒ ì‘ë‹µ**:
```json
{
  "success": false,
  "error": {
    "code": "CHAT_MESSAGE_UNAUTHORIZED_EDIT",
    "message": "ì´ ë©”ì‹œì§€ë¥¼ ìˆ˜ì •í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤"
  }
}
```

---

#### Step 3: User C (ADMIN) - íƒ€ì¸ ë©”ì‹œì§€ ì‚­ì œ
```
1. User C (ê´€ë¦¬ì) ë¡œê·¸ì¸
2. User Aì˜ ë¶€ì ì ˆí•œ ë©”ì‹œì§€ì— ë§ˆìš°ìŠ¤ ì˜¤ë²„
3. "ì‚­ì œ" ë²„íŠ¼ í´ë¦­
4. í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ "ì‚­ì œ" ì„ íƒ
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… DELETE /api/studies/[id]/chat/[messageId] ì„±ê³µ
- âœ… User A, User Bì—ê²Œ "message-deleted" Socket ì´ë²¤íŠ¸
- âœ… ëª¨ë“  í™”ë©´ì—ì„œ ë©”ì‹œì§€ ì œê±°
- âœ… ê´€ë¦¬ì ì‚­ì œ ë¡œê·¸ ê¸°ë¡

**ì˜ˆìƒ User C Console ë¡œê·¸**:
```javascript
[Chat Info] Message deleted by admin
{
  studyId: '...',
  messageId: '...',
  deletedBy: 'admin',
  userRole: 'ADMIN'
}
```

---

## ì‹œë‚˜ë¦¬ì˜¤ 3: ì˜ˆì™¸ ìƒí™© ì²˜ë¦¬ (ì—ëŸ¬ ì¼€ì´ìŠ¤)

### ëª©í‘œ
ë‹¤ì–‘í•œ ì˜ˆì™¸ ìƒí™©ì—ì„œ ì ì ˆí•œ ì—ëŸ¬ ì²˜ë¦¬ ë° ì‚¬ìš©ì í”¼ë“œë°± ê²€ì¦

#### Test 3-1: ë¹ˆ ë©”ì‹œì§€ ì „ì†¡
```
1. User A: ì…ë ¥ì°½ì— ê³µë°±ë§Œ ì…ë ¥ ("   ")
2. ì „ì†¡ ë²„íŠ¼ í´ë¦­
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… í´ë¼ì´ì–¸íŠ¸ ê²€ì¦: ì „ì†¡ ë²„íŠ¼ ë¹„í™œì„±í™” (ì„ íƒì )
- âœ… API ìš”ì²­ ì‹œ: `400 Bad Request`
- âœ… ErrorToast í‘œì‹œ: "ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”"

**ì˜ˆìƒ ì‘ë‹µ**:
```json
{
  "success": false,
  "error": {
    "code": "CHAT_MESSAGE_EMPTY_CONTENT",
    "message": "ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”"
  }
}
```

---

#### Test 3-2: ê¸´ ë©”ì‹œì§€ ì „ì†¡ (5000ì ì´ˆê³¼)
```
1. User A: ì…ë ¥ì°½ì— 5001ì ì…ë ¥
2. ì „ì†¡ ì‹œë„
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… POST /api/studies/[id]/chat ì‹¤íŒ¨
- âœ… ErrorToast: "ë©”ì‹œì§€ëŠ” 5000ì ì´í•˜ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš” (5001/5000)"
- âœ… ì…ë ¥ì°½ ë‚´ìš© ìœ ì§€ (ë°ì´í„° ì†ì‹¤ ì—†ìŒ)

**ì˜ˆìƒ ì‘ë‹µ**:
```json
{
  "success": false,
  "error": {
    "code": "CHAT_MESSAGE_CONTENT_TOO_LONG",
    "message": "ë©”ì‹œì§€ëŠ” 5000ì ì´í•˜ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš” (5001/5000)"
  }
}
```

---

#### Test 3-3: XSS ê³µê²© ì‹œë„
```
1. User A: ì…ë ¥ì°½ì— ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ ì…ë ¥
   "<script>alert('XSS')</script>"
2. ì „ì†¡
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… POST /api/studies/[id]/chat ì‹¤íŒ¨
- âœ… ErrorToast: "ë³´ì•ˆìƒ í—ˆìš©ë˜ì§€ ì•ŠëŠ” ë‚´ìš©ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤"
- âœ… XSS ê°ì§€ ë¡œê·¸ ê¸°ë¡

**ì˜ˆìƒ ì‘ë‹µ**:
```json
{
  "success": false,
  "error": {
    "code": "CHAT_MESSAGE_XSS_DETECTED",
    "message": "ë³´ì•ˆìƒ í—ˆìš©ë˜ì§€ ì•ŠëŠ” ë‚´ìš©ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤"
  }
}
```

**ì˜ˆìƒ Console ë¡œê·¸**:
```javascript
[Chat Warning] XSS attempt detected
{
  studyId: '...',
  userId: '...',
  detectedPattern: '<script>'
}
```

---

#### Test 3-4: ìŠ¤íŒ¸ ë©”ì‹œì§€ ì—°ì† ì „ì†¡
```
1. User A: ë©”ì‹œì§€ 10ê°œë¥¼ 5ì´ˆ ë‚´ì— ì—°ì† ì „ì†¡
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… ì²˜ìŒ 9ê°œ ì„±ê³µ
- âœ… 10ë²ˆì§¸ ë©”ì‹œì§€: `429 Too Many Requests`
- âœ… ErrorToast: "ë©”ì‹œì§€ë¥¼ ë„ˆë¬´ ë¹ ë¥´ê²Œ ì „ì†¡í•˜ê³  ìˆìŠµë‹ˆë‹¤"
- âœ… ì „ì†¡ ë²„íŠ¼ ì¼ì‹œ ë¹„í™œì„±í™” (ì¿¨ë‹¤ìš´)

**ì˜ˆìƒ ì‘ë‹µ (10ë²ˆì§¸)**:
```json
{
  "success": false,
  "error": {
    "code": "CHAT_MESSAGE_SPAM_DETECTED",
    "message": "ë©”ì‹œì§€ë¥¼ ë„ˆë¬´ ë¹ ë¥´ê²Œ ì „ì†¡í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
  }
}
```

**ì˜ˆìƒ Console ë¡œê·¸**:
```javascript
[Chat Warning] Spam detected
{
  studyId: '...',
  userId: '...',
  messageCount: 10,
  timeWindow: '5ì´ˆ'
}
```

---

#### Test 3-5: íŒŒì¼ í¬ê¸° ì´ˆê³¼ (10MB ì´ˆê³¼)
```
1. User A: 15MB íŒŒì¼ ì„ íƒ
2. ì „ì†¡ ì‹œë„
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… í´ë¼ì´ì–¸íŠ¸ ê²€ì¦: íŒŒì¼ ì„ íƒ ì·¨ì†Œ
- âœ… ErrorToast: "íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤ (15MB)"
- âœ… API ìš”ì²­ ì „ì— ì°¨ë‹¨

---

#### Test 3-6: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë©”ì‹œì§€ ìˆ˜ì •
```
1. User A: ì´ë¯¸ ì‚­ì œëœ ë©”ì‹œì§€ IDë¡œ PATCH ìš”ì²­
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… PATCH /api/studies/[id]/chat/[messageId] ì‹¤íŒ¨
- âœ… `404 Not Found` ì‘ë‹µ
- âœ… ErrorToast: "ë©”ì‹œì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"

**ì˜ˆìƒ ì‘ë‹µ**:
```json
{
  "success": false,
  "error": {
    "code": "CHAT_MESSAGE_NOT_FOUND",
    "message": "ë©”ì‹œì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
  }
}
```

---

#### Test 3-7: ê¶Œí•œ ì—†ëŠ” ì‚¬ìš©ì ì ‘ê·¼
```
1. User D (ë¹„ë©¤ë²„): ìŠ¤í„°ë”” ì±„íŒ… URL ì§ì ‘ ì ‘ê·¼
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… GET /api/studies/[id]/chat ì‹¤íŒ¨
- âœ… `403 Forbidden` ì‘ë‹µ
- âœ… ì±„íŒ… UI ì ‘ê·¼ ì°¨ë‹¨ ë˜ëŠ” ì—ëŸ¬ í™”ë©´

**ì˜ˆìƒ ì‘ë‹µ**:
```json
{
  "success": false,
  "error": {
    "code": "UNAUTHORIZED",
    "message": "ìŠ¤í„°ë”” ë©¤ë²„ë§Œ ì±„íŒ…ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"
  }
}
```

---

## ì‹œë‚˜ë¦¬ì˜¤ 4: Socket ì—°ê²° ì¥ì•  ë³µêµ¬

### ëª©í‘œ
ë„¤íŠ¸ì›Œí¬ ë¶ˆì•ˆì • ì‹œ ìë™ ì¬ì—°ê²° ë° ë°ì´í„° ë™ê¸°í™” ê²€ì¦

#### Test 4-1: Socket ì—°ê²° ëŠê¹€ ì‹œë®¬ë ˆì´ì…˜
```
1. User A: ì±„íŒ… ì¤‘
2. ê°œë°œì ë„êµ¬ > Network íƒ­ > "Offline" ì„ íƒ
3. 5ì´ˆ ëŒ€ê¸°
4. "Online" ë³µêµ¬
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… ì—°ê²° ëŠê¹€ ê°ì§€ (`SOCKET_DISCONNECTED` ì´ë²¤íŠ¸)
- âœ… Connection Banner: "Reconnecting..." í‘œì‹œ
- âœ… ìë™ ì¬ì—°ê²° ì‹œë„ (3íšŒ, 1ì´ˆ/2ì´ˆ/4ì´ˆ ê°„ê²©)
- âœ… ì¬ì—°ê²° ì„±ê³µ í›„ Banner: "Connected"
- âœ… ì±„íŒ…ë°© ìë™ ì¬ì°¸ì—¬ (`CHAT_JOINED`)
- âœ… ëˆ„ë½ëœ ë©”ì‹œì§€ ìë™ ë™ê¸°í™”

**ì˜ˆìƒ Console ë¡œê·¸**:
```javascript
[Socket] Disconnected from study-chat-{studyId}
[ConnectionBanner] Status: reconnecting
[Socket] Reconnecting... (attempt 1/3)
[Socket] Reconnected successfully
[Chat Info] Messages synced after reconnection
{
  studyId: '...',
  newMessagesCount: 3
}
```

---

#### Test 4-2: ì¬ì—°ê²° ì‹¤íŒ¨ (ë„¤íŠ¸ì›Œí¬ ì™„ì „ ì°¨ë‹¨)
```
1. User A: Offline ìƒíƒœ ìœ ì§€
2. 3ë²ˆ ì¬ì—°ê²° ì‹œë„ ëª¨ë‘ ì‹¤íŒ¨
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… Connection Banner: "Offline" í‘œì‹œ (ë¹¨ê°„ìƒ‰)
- âœ… ë©”ì‹œì§€ ì…ë ¥ ë¹„í™œì„±í™”
- âœ… ErrorToast: "ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”"
- âœ… "ì¬ì—°ê²° ì‹œë„" ë²„íŠ¼ í‘œì‹œ

**ì˜ˆìƒ Console ë¡œê·¸**:
```javascript
[Socket] Reconnection attempt 3/3 failed
[ConnectionBanner] Status: offline
[Error] Maximum reconnection attempts reached
```

---

#### Test 4-3: ì „ì†¡ ì¤‘ ì—°ê²° ëŠê¹€
```
1. User A: ë©”ì‹œì§€ ì „ì†¡ ì‹œì‘
2. ì „ì†¡ ì¤‘ ë„¤íŠ¸ì›Œí¬ ëŠê¹€ ì‹œë®¬ë ˆì´ì…˜
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… ë‚™ê´€ì  ì—…ë°ì´íŠ¸: ë©”ì‹œì§€ pending ìƒíƒœë¡œ í‘œì‹œ
- âœ… API ìš”ì²­ ì‹¤íŒ¨ ê°ì§€
- âœ… MessageError í‘œì‹œ: "ì „ì†¡ ì‹¤íŒ¨"
- âœ… "ì¬ì‹œë„" ë²„íŠ¼ í´ë¦­ ì‹œ ì¬ì „ì†¡
- âœ… ì¬ì—°ê²° í›„ ìë™ ì¬ì „ì†¡ (ì„ íƒì )

**ì˜ˆìƒ UI**:
```
[ë©”ì‹œì§€ ë²„ë¸”]
"ì•ˆë…•í•˜ì„¸ìš”"
âš ï¸ ì „ì†¡ ì‹¤íŒ¨ [ì¬ì‹œë„]
```

---

## ì‹œë‚˜ë¦¬ì˜¤ 5: ëŒ€ìš©ëŸ‰ ë©”ì‹œì§€ ë¡œë”© ë° í˜ì´ì§€ë„¤ì´ì…˜

### ëª©í‘œ
ë§ì€ ë©”ì‹œì§€ê°€ ìˆì„ ë•Œ ì„±ëŠ¥ ë° UX ê²€ì¦

#### Test 5-1: ì´ˆê¸° ë©”ì‹œì§€ ë¡œë”© (100ê°œ ì´ìƒ)
```
1. User A: ë©”ì‹œì§€ 100ê°œ ì´ìƒ ìˆëŠ” ì±„íŒ…ë°© ì…ì¥
2. ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ ì˜¬ë¦¼
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… GET /api/studies/[id]/chat?limit=50 í˜¸ì¶œ
- âœ… ìµœì‹  50ê°œë§Œ ë¡œë”©
- âœ… hasMore: true ë°˜í™˜
- âœ… ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ
- âœ… 1ì´ˆ ì´ë‚´ ë Œë”ë§

**ì˜ˆìƒ Console ë¡œê·¸**:
```javascript
[Chat Info] Messages fetched successfully
{
  studyId: '...',
  count: 50,
  hasMore: true,
  nextCursor: 'msg-id-51'
}
```

---

#### Test 5-2: ë¬´í•œ ìŠ¤í¬ë¡¤ (ì´ì „ ë©”ì‹œì§€ ë¡œë”©)
```
1. User A: ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ ê³„ì† ì˜¬ë¦¼
2. ì¶”ê°€ ë©”ì‹œì§€ ë¡œë”© íŠ¸ë¦¬ê±°
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… Intersection Observer ê°ì§€
- âœ… GET /api/studies/[id]/chat?cursor={nextCursor}&limit=50
- âœ… ê¸°ì¡´ ë©”ì‹œì§€ ìœ ì§€ + ì´ì „ ë©”ì‹œì§€ ì¶”ê°€
- âœ… ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ìœ ì§€ (ì í”„ ì—†ìŒ)
- âœ… ì¤‘ë³µ ë¡œë”© ë°©ì§€

**ì˜ˆìƒ Console ë¡œê·¸**:
```javascript
[Chat Info] Loading more messages
{
  studyId: '...',
  cursor: 'msg-id-51',
  direction: 'before'
}
[Chat Info] Messages fetched successfully
{
  count: 50,
  hasMore: true,
  nextCursor: 'msg-id-101'
}
```

---

#### Test 5-3: ë§ˆì§€ë§‰ í˜ì´ì§€ ë„ë‹¬
```
1. User A: ìŠ¤í¬ë¡¤ ê³„ì† ì˜¬ë ¤ì„œ ì²« ë©”ì‹œì§€ê¹Œì§€ ë„ë‹¬
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… hasMore: false ë°˜í™˜
- âœ… "ì²˜ìŒ ë©”ì‹œì§€ì…ë‹ˆë‹¤" ì•ˆë‚´ í‘œì‹œ
- âœ… ë” ì´ìƒ API ìš”ì²­ ì—†ìŒ

---

## ì‹œë‚˜ë¦¬ì˜¤ 6: ë™ì‹œì„± ì²˜ë¦¬

### ëª©í‘œ
ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ë™ì‹œì— ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ë•Œ ë°ì´í„° ì¼ê´€ì„± ê²€ì¦

#### Test 6-1: ë™ì‹œ ë©”ì‹œì§€ ì „ì†¡
```
1. User A, User B: ë™ì‹œì— (1ì´ˆ ì´ë‚´) ë©”ì‹œì§€ ì „ì†¡
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… ë‘ ë©”ì‹œì§€ ëª¨ë‘ ì„±ê³µì ìœ¼ë¡œ ì €ì¥
- âœ… ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •í™•í•œ ìˆœì„œë¡œ í‘œì‹œ
- âœ… íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ì¤€ ì •ë ¬
- âœ… ì¤‘ë³µ ë©”ì‹œì§€ ì—†ìŒ

---

#### Test 6-2: ì½ìŒ ì²˜ë¦¬ ë™ì‹œì„±
```
1. User A, User B, User C: ë™ì‹œì— ë©”ì‹œì§€ ì½ìŒ
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… ì¤‘ë³µ ì½ìŒ ë°©ì§€ (POST /api/studies/[id]/chat/read)
- âœ… lastReadMessageId ì •í™•íˆ ì—…ë°ì´íŠ¸
- âœ… ì½ìŒ ìƒíƒœ ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ ë™ê¸°í™”

**ì˜ˆìƒ Console ë¡œê·¸**:
```javascript
[Chat Info] Messages marked as read (no duplicates)
{
  studyId: '...',
  userId: 'user-a-id',
  count: 0,
  reason: 'already_read'
}
```

---

## ì‹œë‚˜ë¦¬ì˜¤ 7: UI/UX í†µí•©

### ëª©í‘œ
ì „ì²´ ì‚¬ìš©ì ê²½í—˜ ë° UI ì»´í¬ë„ŒíŠ¸ í†µí•© ê²€ì¦

#### Test 7-1: ì—ëŸ¬ í† ìŠ¤íŠ¸ ìë™ ë‹«í˜
```
1. User A: ì—ëŸ¬ ë°œìƒ (ì˜ˆ: ë¹ˆ ë©”ì‹œì§€ ì „ì†¡)
2. ErrorToast í‘œì‹œ
3. 5ì´ˆ ëŒ€ê¸°
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… 5ì´ˆ í›„ ìë™ìœ¼ë¡œ ì‚¬ë¼ì§
- âœ… slide-up ì• ë‹ˆë©”ì´ì…˜
- âœ… X ë²„íŠ¼ í´ë¦­ ì‹œ ì¦‰ì‹œ ë‹«í˜

---

#### Test 7-2: ë¹ˆ ìƒíƒœ í‘œì‹œ
```
1. User A: ìƒˆ ìŠ¤í„°ë”” ì±„íŒ…ë°© ì…ì¥ (ë©”ì‹œì§€ 0ê°œ)
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… EmptyState ì»´í¬ë„ŒíŠ¸ í‘œì‹œ
- âœ… "ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤" ì•ˆë‚´
- âœ… ì¹œê·¼í•œ ì•„ì´ì½˜/ì´ë¯¸ì§€
- âœ… ë©”ì‹œì§€ ì „ì†¡ ì‹œ EmptyState ì‚¬ë¼ì§

---

#### Test 7-3: ë¡œë”© ìŠ¤í”¼ë„ˆ
```
1. User A: ì±„íŒ…ë°© ì…ì¥
2. ë„¤íŠ¸ì›Œí¬ ì†ë„ ì œí•œ (ê°œë°œì ë„êµ¬ > Network > Slow 3G)
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… LoadingSpinner í‘œì‹œ
- âœ… ì¤‘ì•™ ì •ë ¬
- âœ… ì• ë‹ˆë©”ì´ì…˜ ë¶€ë“œëŸ¬ì›€
- âœ… ë¡œë”© ì™„ë£Œ í›„ ì‚¬ë¼ì§

---

#### Test 7-4: ë©”ì‹œì§€ ê·¸ë£¹í™”
```
1. User A: ì—°ì† 3ê°œ ë©”ì‹œì§€ ì „ì†¡
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… ê°™ì€ ì‚¬ìš©ìì˜ ì—°ì† ë©”ì‹œì§€ ê·¸ë£¹í™”
- âœ… ì²« ë©”ì‹œì§€ë§Œ í”„ë¡œí•„ ì‚¬ì§„ í‘œì‹œ
- âœ… ë§ˆì§€ë§‰ ë©”ì‹œì§€ë§Œ íƒ€ì„ìŠ¤íƒ¬í”„ í‘œì‹œ
- âœ… 5ë¶„ ì´ìƒ ê°„ê²© ì‹œ ê·¸ë£¹ ë¶„ë¦¬

---

## ğŸ“Š í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

### Socket ì—°ê²° (6ê°œ)
- [ ] 1-1. ì´ˆê¸° ì—°ê²° ì„±ê³µ
- [ ] 1-2. ì±„íŒ…ë°© ì°¸ì—¬ (join)
- [ ] 1-3. ë‹¤ì¤‘ ì‚¬ìš©ì ë™ì‹œ ì ‘ì†
- [ ] 4-1. ì—°ê²° ëŠê¹€ ë° ì¬ì—°ê²°
- [ ] 4-2. ì¬ì—°ê²° ì‹¤íŒ¨ ì²˜ë¦¬
- [ ] 4-3. ì „ì†¡ ì¤‘ ì—°ê²° ëŠê¹€

### ë©”ì‹œì§€ ì†¡ìˆ˜ì‹  (8ê°œ)
- [ ] 1-3. ë©”ì‹œì§€ ì „ì†¡ (í…ìŠ¤íŠ¸)
- [ ] 1-4. ì½ìŒ ì²˜ë¦¬
- [ ] 1-5. íŒŒì¼ ì²¨ë¶€ ë©”ì‹œì§€
- [ ] 2-1. ë©”ì‹œì§€ ìˆ˜ì •
- [ ] 2-3. ë©”ì‹œì§€ ì‚­ì œ (ê´€ë¦¬ì)
- [ ] 6-1. ë™ì‹œ ë©”ì‹œì§€ ì „ì†¡
- [ ] 6-2. ì½ìŒ ì²˜ë¦¬ ë™ì‹œì„±
- [ ] 7-4. ë©”ì‹œì§€ ê·¸ë£¹í™”

### ì˜ˆì™¸ ì²˜ë¦¬ (7ê°œ)
- [ ] 3-1. ë¹ˆ ë©”ì‹œì§€ ì „ì†¡
- [ ] 3-2. ê¸´ ë©”ì‹œì§€ (5000ì ì´ˆê³¼)
- [ ] 3-3. XSS ê³µê²© ì‹œë„
- [ ] 3-4. ìŠ¤íŒ¸ ë©”ì‹œì§€ ì—°ì† ì „ì†¡
- [ ] 3-5. íŒŒì¼ í¬ê¸° ì´ˆê³¼
- [ ] 3-6. ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë©”ì‹œì§€ ìˆ˜ì •
- [ ] 3-7. ê¶Œí•œ ì—†ëŠ” ì‚¬ìš©ì ì ‘ê·¼

### ê¶Œí•œ ê²€ì¦ (3ê°œ)
- [ ] 2-2. íƒ€ì¸ ë©”ì‹œì§€ ìˆ˜ì • ì‹œë„
- [ ] 2-3. ê´€ë¦¬ì ì‚­ì œ ê¶Œí•œ
- [ ] 3-7. ë¹„ë©¤ë²„ ì ‘ê·¼ ì°¨ë‹¨

### í˜ì´ì§€ë„¤ì´ì…˜ (3ê°œ)
- [ ] 5-1. ì´ˆê¸° ë©”ì‹œì§€ ë¡œë”©
- [ ] 5-2. ë¬´í•œ ìŠ¤í¬ë¡¤
- [ ] 5-3. ë§ˆì§€ë§‰ í˜ì´ì§€ ë„ë‹¬

### UI/UX (4ê°œ)
- [ ] 7-1. ì—ëŸ¬ í† ìŠ¤íŠ¸ ìë™ ë‹«í˜
- [ ] 7-2. ë¹ˆ ìƒíƒœ í‘œì‹œ
- [ ] 7-3. ë¡œë”© ìŠ¤í”¼ë„ˆ
- [ ] 7-4. ë©”ì‹œì§€ ê·¸ë£¹í™”

---

## ğŸ” ë¡œê·¸ ëª¨ë‹ˆí„°ë§ í¬ì¸íŠ¸

### ì„±ê³µ ì¼€ì´ìŠ¤ ë¡œê·¸
```javascript
[Chat Info] Messages fetched successfully
[Chat Info] Message sent successfully
[Chat Info] Message updated successfully
[Chat Info] Messages marked as read
[Socket] Connected to study-chat-{studyId}
[Socket] Received new-message event
```

### ê²½ê³  ë¡œê·¸
```javascript
[Chat Warning] Unauthorized access attempt
[Chat Warning] XSS attempt detected
[Chat Warning] Spam detected
[Chat Warning] Invalid limit parameter
```

### ì—ëŸ¬ ë¡œê·¸
```javascript
[Chat Error] Failed to fetch messages
[Chat Error] Failed to send message
[Socket] Disconnected from study-chat-{studyId}
[Socket] Reconnection attempt 3/3 failed
```

---

## ğŸ“ˆ ì„±ëŠ¥ ê¸°ì¤€

### ì‘ë‹µ ì‹œê°„
- ë©”ì‹œì§€ ì¡°íšŒ (GET): < 500ms
- ë©”ì‹œì§€ ì „ì†¡ (POST): < 1000ms
- Socket ì´ë²¤íŠ¸ ìˆ˜ì‹ : < 100ms
- ë¬´í•œ ìŠ¤í¬ë¡¤: < 500ms

### ë„¤íŠ¸ì›Œí¬
- ì´ˆê¸° ë¡œë”©: < 50 API ìš”ì²­
- ë©”ì‹œì§€ë‹¹ Socket ì´ë²¤íŠ¸: 1ê°œ
- ì¬ì—°ê²° ì‹œê°„: < 5ì´ˆ

---

## ğŸ¯ í†µê³¼ ê¸°ì¤€

### í•„ìˆ˜ (Must Pass)
- âœ… ëª¨ë“  ì •ìƒ ì¼€ì´ìŠ¤ ë™ì‘
- âœ… ëª¨ë“  ì˜ˆì™¸ ì²˜ë¦¬ ë™ì‘
- âœ… ê¶Œí•œ ê²€ì¦ 100%
- âœ… ì—ëŸ¬ ë©”ì‹œì§€ ì‚¬ìš©ì ì¹œí™”ì 
- âœ… ë°ì´í„° ì†ì‹¤ ì—†ìŒ

### ê¶Œì¥ (Should Pass)
- âœ… ì„±ëŠ¥ ê¸°ì¤€ ì¶©ì¡±
- âœ… ë¡œê·¸ ì™„ì „ì„±
- âœ… UI/UX ì¼ê´€ì„±
- âœ… ì ‘ê·¼ì„± (Accessibility)

---

## ğŸ“ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ê¸°ë¡

### í…œí”Œë¦¿
```markdown
## í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê²°ê³¼

**ì¼ì‹œ**: 2025-12-01
**í…ŒìŠ¤í„°**: [ì´ë¦„]
**í™˜ê²½**: Windows 11, Chrome 120

### í†µê³¼ í•­ëª© (23/31)
- âœ… 1-1. ì´ˆê¸° ì—°ê²° ì„±ê³µ
- âœ… 1-3. ë©”ì‹œì§€ ì „ì†¡
- âŒ 4-1. ì—°ê²° ëŠê¹€ ì¬ì—°ê²° (ì´ìœ : ...)

### ë°œê²¬ëœ ì´ìŠˆ
1. **[Critical]** ì¬ì—°ê²° ì‹œ ë©”ì‹œì§€ ì¤‘ë³µ í‘œì‹œ
   - ì¬í˜„: Step 4-1 ìˆ˜í–‰ ì‹œ
   - ì˜ˆìƒ: ì¤‘ë³µ ì—†ìŒ
   - ì‹¤ì œ: ë§ˆì§€ë§‰ 3ê°œ ë©”ì‹œì§€ 2ë²ˆ í‘œì‹œ

2. **[Minor]** ì—ëŸ¬ í† ìŠ¤íŠ¸ ìœ„ì¹˜ ì–´ê¸‹ë‚¨
   - ì¬í˜„: ëª¨ë°”ì¼ í™”ë©´ì—ì„œ
   - ì˜ˆìƒ: ìƒë‹¨ ì¤‘ì•™
   - ì‹¤ì œ: ìš°ì¸¡ ìƒë‹¨
```

---

**ë‹¤ìŒ ë‹¨ê³„**: E2E ìë™í™” í…ŒìŠ¤íŠ¸ ì‘ì„± (ì„ íƒì )

