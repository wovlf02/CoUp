// Prisma ì„¤ì •
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ì‚¬ìš©ì (User)
// ============================================
model User {
  id       String   @id @default(cuid())
  email    String   @unique
  password String? // null for OAuth users
  name     String?
  avatar   String?
  bio      String?
  provider Provider @default(CREDENTIALS)
  role     UserRole @default(USER)

  // ì†Œì…œ ë¡œê·¸ì¸
  googleId String? @unique
  githubId String? @unique

  // ìƒíƒœ
  status         UserStatus @default(ACTIVE)
  suspendedUntil DateTime?
  suspendReason  String?

  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // ê´€ê³„
  ownedStudies       Study[]             @relation("StudyOwner")
  studyMembers       StudyMember[]
  messages           Message[]
  notifications      Notification[]
  tasks              Task[]
  reports            Report[]
  createdNotices     Notice[]
  uploadedFiles      File[]              @relation("FileUploader")
  createdEvents      Event[]             @relation("EventCreator")
  createdStudyTasks  StudyTask[]         @relation("StudyTaskCreator")
  assignedStudyTasks StudyTaskAssignee[] @relation("TaskAssignee")

  @@index([email])
  @@index([status])
}

enum Provider {
  CREDENTIALS
  GOOGLE
  GITHUB
}

enum UserRole {
  USER
  ADMIN
  SYSTEM_ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

// ============================================
// ìŠ¤í„°ë”” (Study)
// ============================================
model Study {
  id          String  @id @default(cuid())
  ownerId     String
  name        String
  emoji       String  @default("ğŸ“š")
  description String  @db.Text
  category    String
  subCategory String?

  // ì„¤ì •
  maxMembers   Int     @default(20)
  isPublic     Boolean @default(true)
  autoApprove  Boolean @default(true)
  isRecruiting Boolean @default(true)

  // í‰ê°€
  rating      Float? @default(0)
  reviewCount Int?   @default(0)

  // ë©”íƒ€
  tags       String[] // PostgreSQL array
  inviteCode String   @unique @default(cuid())

  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ê´€ê³„
  owner      User          @relation("StudyOwner", fields: [ownerId], references: [id])
  members    StudyMember[]
  messages   Message[]
  notices    Notice[]
  files      File[]
  events     Event[]
  tasks      Task[]
  studyTasks StudyTask[]

  @@index([category])
  @@index([isPublic, isRecruiting])
  @@index([ownerId])
  @@index([rating])
}

// ============================================
// ìŠ¤í„°ë”” ë©¤ë²„ (StudyMember)
// ============================================
model StudyMember {
  id      String       @id @default(cuid())
  studyId String
  userId  String
  role    MemberRole   @default(MEMBER)
  status  MemberStatus @default(PENDING)

  // ê°€ì… ì •ë³´
  introduction String? @db.Text
  motivation   String?
  level        String?

  // íƒ€ì„ìŠ¤íƒ¬í”„
  joinedAt   DateTime  @default(now())
  approvedAt DateTime?

  // ê´€ê³„
  study Study @relation(fields: [studyId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([studyId, userId])
  @@index([userId])
  @@index([status])
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
}

enum MemberStatus {
  PENDING
  ACTIVE
  KICKED
  LEFT
}

// ============================================
// ì±„íŒ… ë©”ì‹œì§€ (Message)
// ============================================
model Message {
  id      String  @id @default(cuid())
  studyId String
  userId  String
  content String  @db.Text
  fileId  String?

  // ì½ìŒ ì²˜ë¦¬
  readers String[] // User IDs array

  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ê´€ê³„
  study Study @relation(fields: [studyId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id])
  file  File? @relation(fields: [fileId], references: [id])

  @@index([studyId, createdAt])
}

// ============================================
// ê³µì§€ì‚¬í•­ (Notice)
// ============================================
model Notice {
  id       String @id @default(cuid())
  studyId  String
  authorId String
  title    String
  content  String @db.Text

  // ìƒíƒœ
  isPinned    Boolean @default(false)
  isImportant Boolean @default(false)

  // í†µê³„
  views Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  study  Study @relation(fields: [studyId], references: [id], onDelete: Cascade)
  author User  @relation(fields: [authorId], references: [id])

  @@index([studyId, isPinned, createdAt])
  @@index([authorId])
}

// ============================================
// íŒŒì¼ (File)
// ============================================
model File {
  id         String  @id @default(cuid())
  studyId    String
  uploaderId String
  name       String
  size       Int
  type       String
  url        String
  folderId   String?

  downloads Int @default(0)

  createdAt DateTime @default(now())

  study    Study     @relation(fields: [studyId], references: [id], onDelete: Cascade)
  uploader User      @relation("FileUploader", fields: [uploaderId], references: [id])
  messages Message[]

  @@index([studyId, folderId])
  @@index([uploaderId])
}

// ============================================
// ìº˜ë¦°ë” ì¼ì • (Event)
// ============================================
model Event {
  id          String   @id @default(cuid())
  studyId     String
  createdById String
  title       String
  date        DateTime @db.Date
  startTime   String
  endTime     String
  location    String?
  color       String   @default("#6366F1")

  createdAt DateTime @default(now())

  study     Study @relation(fields: [studyId], references: [id], onDelete: Cascade)
  createdBy User  @relation("EventCreator", fields: [createdById], references: [id])

  @@index([studyId, date])
  @@index([createdById])
}

// ============================================
// í• ì¼ (Task) - ê°œì¸ìš©
// ============================================
model Task {
  id          String     @id @default(cuid())
  studyId     String?
  userId      String
  title       String
  description String?    @db.Text
  status      TaskStatus @default(TODO)
  priority    Priority   @default(MEDIUM)
  dueDate     DateTime?

  completed   Boolean   @default(false)
  completedAt DateTime?

  createdAt DateTime @default(now())

  user  User   @relation(fields: [userId], references: [id])
  study Study? @relation(fields: [studyId], references: [id], onDelete: Cascade)

  @@index([userId, completed])
  @@index([studyId, status])
}

// ============================================
// ìŠ¤í„°ë”” í• ì¼ (StudyTask) - ìŠ¤í„°ë”” ê³µìœ ìš©
// ============================================
model StudyTask {
  id          String     @id @default(cuid())
  studyId     String
  createdById String
  title       String
  description String?    @db.Text
  status      TaskStatus @default(TODO)
  priority    Priority   @default(MEDIUM)
  dueDate     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  study     Study               @relation(fields: [studyId], references: [id], onDelete: Cascade)
  createdBy User                @relation("StudyTaskCreator", fields: [createdById], references: [id])
  assignees StudyTaskAssignee[]

  @@index([studyId, status])
  @@index([createdById])
}

model StudyTaskAssignee {
  id     String @id @default(cuid())
  taskId String
  userId String

  assignedAt DateTime @default(now())

  task StudyTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User      @relation("TaskAssignee", fields: [userId], references: [id])

  @@unique([taskId, userId])
  @@index([userId])
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ============================================
// ì•Œë¦¼ (Notification)
// ============================================
model Notification {
  id         String           @id @default(cuid())
  userId     String
  type       NotificationType
  studyId    String?
  studyName  String?
  studyEmoji String?
  message    String
  data       Json? // ì¶”ê°€ ë°ì´í„°

  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
}

enum NotificationType {
  JOIN_APPROVED
  NOTICE
  FILE
  EVENT
  TASK
  MEMBER
  KICK
  CHAT
}

// ============================================
// ì‹ ê³  (Report)
// ============================================
model Report {
  id         String     @id @default(cuid())
  reporterId String
  targetType TargetType
  targetId   String
  targetName String? // ì‹ ê³  ëŒ€ìƒ ì´ë¦„ (ìºì‹œ)
  type       ReportType
  reason     String     @db.Text
  evidence   Json? // ì¦ê±° ìë£Œ

  status   ReportStatus @default(PENDING)
  priority Priority     @default(MEDIUM)

  // ì²˜ë¦¬
  processedBy String?
  processedAt DateTime?
  resolution  String?   @db.Text

  createdAt DateTime @default(now())

  reporter User @relation(fields: [reporterId], references: [id])

  @@index([status, priority, createdAt])
  @@index([targetType, targetId])
}

enum TargetType {
  USER
  STUDY
  MESSAGE
}

enum ReportType {
  SPAM
  HARASSMENT
  INAPPROPRIATE
  COPYRIGHT
  OTHER
}

enum ReportStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
  REJECTED
}

// ============================================
// ì‹œìŠ¤í…œ ì„¤ì • (Setting)
// ============================================
model Setting {
  id    String      @id @default(cuid())
  key   String      @unique
  value String      @db.Text
  type  SettingType @default(STRING)

  updatedAt DateTime @updatedAt
  updatedBy String?

  @@index([key])
}

enum SettingType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

// ============================================
// ì œì¬ (Sanction) - ê´€ë¦¬ì ì‹œìŠ¤í…œ
// ============================================
model Sanction {
  id     String       @id @default(cuid())
  userId String
  type   SanctionType

  // ì œì¬ ì •ë³´
  reason          String  @db.Text
  duration        String? // '1ì¼', '3ì¼', '7ì¼', '30ì¼', 'ì˜êµ¬'
  relatedReportId String?

  // ê´€ë¦¬ì
  adminId String

  // ì •ì§€ í•´ì œ ì •ë³´
  unsuspendReason  String?
  unsuspendAdminId String?
  unsuspendAt      DateTime?

  createdAt DateTime @default(now())

  @@index([userId, type, createdAt])
  @@index([adminId])
}

enum SanctionType {
  WARNING
  SUSPEND
  UNSUSPEND
  RESTRICT
}

// ============================================
// ê¸°ëŠ¥ ì œí•œ (FunctionRestriction) - ê´€ë¦¬ì ì‹œìŠ¤í…œ
// ============================================
model FunctionRestriction {
  id                  String   @id @default(cuid())
  userId              String
  restrictedFunctions String[] // ['CHAT', 'STUDY_CREATE', 'FILE_UPLOAD', 'NOTICE_CREATE']
  restrictedUntil     DateTime
  reason              String   @db.Text
  adminId             String

  createdAt DateTime @default(now())

  @@index([userId, restrictedUntil])
}

// ============================================
// ê´€ë¦¬ì ë¡œê·¸ (AdminLog) - ê´€ë¦¬ì ì‹œìŠ¤í…œ
// ============================================
model AdminLog {
  id         String      @id @default(cuid())
  adminId    String
  action     AdminAction
  targetType String? // 'User', 'Study', 'Report' ë“±
  targetId   String?
  details    Json? // ìƒì„¸ ì •ë³´

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([adminId, createdAt])
  @@index([action, createdAt])
}

enum AdminAction {
  USER_WARN
  USER_SUSPEND
  USER_UNSUSPEND
  USER_RESTRICT
  USER_DELETE
  STUDY_HIDE
  STUDY_CLOSE
  STUDY_RECOMMEND
  REPORT_ASSIGN
  REPORT_APPROVE
  REPORT_REJECT
  CONTENT_DELETE
  SETTINGS_UPDATE
}
