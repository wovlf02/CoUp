# 5. ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„

## ë°ì´í„°ë² ì´ìŠ¤ ê°œìš”

| í•­ëª© | ë‚´ìš© |
|------|------|
| **DBMS** | PostgreSQL 15 |
| **ORM** | Prisma 6 |
| **ëª¨ë¸ ìˆ˜** | 15ê°œ+ |
| **ê´€ê³„** | 1:N, N:M (ì¤‘ê°„ í…Œì´ë¸” ì‚¬ìš©) |

---

## ERD (Entity Relationship Diagram)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              í•µì‹¬ ERD                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚                            â”‚    User     â”‚                                  â”‚
â”‚                            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                  â”‚
â”‚                            â”‚ id          â”‚                                  â”‚
â”‚                            â”‚ email       â”‚                                  â”‚
â”‚                            â”‚ name        â”‚                                  â”‚
â”‚                            â”‚ role        â”‚                                  â”‚
â”‚                            â”‚ status      â”‚                                  â”‚
â”‚                            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                                   â”‚                                          â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚        â”‚                          â”‚                          â”‚              â”‚
â”‚        â–¼                          â–¼                          â–¼              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚ â”‚    Study    â”‚          â”‚ StudyMember â”‚          â”‚ Notificationâ”‚          â”‚
â”‚ â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚          â”‚
â”‚ â”‚ id          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ studyId     â”‚          â”‚ id          â”‚          â”‚
â”‚ â”‚ ownerId     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ userId      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ userId      â”‚          â”‚
â”‚ â”‚ name        â”‚          â”‚ role        â”‚          â”‚ type        â”‚          â”‚
â”‚ â”‚ category    â”‚          â”‚ status      â”‚          â”‚ message     â”‚          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ isRead      â”‚          â”‚
â”‚        â”‚                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚        â”‚                                                                    â”‚
â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚        â”‚               â”‚               â”‚               â”‚              â”‚    â”‚
â”‚        â–¼               â–¼               â–¼               â–¼              â–¼    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚  Message  â”‚   â”‚   Notice  â”‚   â”‚   Event   â”‚   â”‚   File    â”‚  â”‚  Task   â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ì£¼ìš” ëª¨ë¸ ìƒì„¸

### 1. User (ì‚¬ìš©ì)

```prisma
model User {
  id                String     @id @default(cuid())
  email             String     @unique
  password          String?    // OAuth ì‚¬ìš©ìëŠ” null
  name              String?
  avatar            String?
  bio               String?
  provider          Provider   @default(CREDENTIALS)
  role              UserRole   @default(USER)
  
  // ì†Œì…œ ë¡œê·¸ì¸
  googleId          String?    @unique
  githubId          String?    @unique
  
  // ìƒíƒœ
  status            UserStatus @default(ACTIVE)
  suspendedUntil    DateTime?
  suspendReason     String?
  
  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  lastLoginAt       DateTime?
  
  // ê´€ê³„
  ownedStudies      Study[]       @relation("StudyOwner")
  studyMembers      StudyMember[]
  messages          Message[]
  notifications     Notification[]
  tasks             Task[]
  reports           Report[]
  // ... ë” ë§ì€ ê´€ê³„
}

enum Provider {
  CREDENTIALS    // ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ì¸ì¦
  GOOGLE         // Google OAuth
  GITHUB         // GitHub OAuth
}

enum UserRole {
  USER           // ì¼ë°˜ ì‚¬ìš©ì
  ADMIN          // ì‹œìŠ¤í…œ ê´€ë¦¬ì
}

enum UserStatus {
  ACTIVE         // í™œì„±
  SUSPENDED      // ì •ì§€
  DELETED        // ì‚­ì œë¨
}
```

### 2. Study (ìŠ¤í„°ë””)

```prisma
model Study {
  id            String   @id @default(cuid())
  ownerId       String
  name          String
  emoji         String   @default("ğŸ“š")
  description   String   @db.Text
  category      String
  subCategory   String?
  
  // ì„¤ì •
  maxMembers    Int      @default(20)
  isPublic      Boolean  @default(true)
  autoApprove   Boolean  @default(true)
  isRecruiting  Boolean  @default(true)
  
  // í‰ê°€
  rating        Float?   @default(0)
  reviewCount   Int?     @default(0)
  
  // ë©”íƒ€
  tags          String[]  // PostgreSQL ë°°ì—´
  inviteCode    String   @unique @default(cuid())
  
  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // ê´€ê³„
  owner         User          @relation("StudyOwner", ...)
  members       StudyMember[]
  messages      Message[]
  notices       Notice[]
  files         File[]
  events        Event[]
  tasks         Task[]
}
```

### 3. StudyMember (ìŠ¤í„°ë”” ë©¤ë²„)

```prisma
model StudyMember {
  id            String       @id @default(cuid())
  studyId       String
  userId        String
  role          MemberRole   @default(MEMBER)
  status        MemberStatus @default(PENDING)
  
  // ê°€ì… ì •ë³´
  introduction  String?      @db.Text
  motivation    String?
  level         String?
  
  // íƒ€ì„ìŠ¤íƒ¬í”„
  joinedAt      DateTime     @default(now())
  approvedAt    DateTime?
  
  // ë³µí•© ìœ ë‹ˆí¬ ì œì•½
  @@unique([studyId, userId])
}

enum MemberRole {
  OWNER      // ë°©ì¥ (ìŠ¤í„°ë”” ìƒì„±ì)
  ADMIN      // ê´€ë¦¬ì (ë°©ì¥ì´ ì„ëª…)
  MEMBER     // ì¼ë°˜ ë©¤ë²„
}

enum MemberStatus {
  PENDING    // ê°€ì… ëŒ€ê¸° ì¤‘
  ACTIVE     // í™œì„± ë©¤ë²„
  KICKED     // ê°•í‡´ë¨
  LEFT       // íƒˆí‡´í•¨
}
```

### 4. Message (ì±„íŒ… ë©”ì‹œì§€)

```prisma
model Message {
  id        String   @id @default(cuid())
  studyId   String
  userId    String
  content   String   @db.Text
  fileId    String?
  
  // ì½ìŒ ì²˜ë¦¬
  readers   String[]  // User ID ë°°ì—´
  
  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // ê´€ê³„
  study     Study    @relation(...)
  user      User     @relation(...)
  file      File?    @relation(...)
  
  @@index([studyId, createdAt])
}
```

### 5. Notice (ê³µì§€ì‚¬í•­)

```prisma
model Notice {
  id          String  @id @default(cuid())
  studyId     String
  authorId    String
  title       String
  content     String  @db.Text
  
  // ìƒíƒœ
  isPinned    Boolean @default(false)
  isImportant Boolean @default(false)
  
  // í†µê³„
  views       Int     @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // ê´€ê³„
  attachments NoticeFile[]  // ì²¨ë¶€ íŒŒì¼
  study       Study   @relation(...)
  author      User    @relation(...)
}
```

### 6. Task (ê°œì¸ í• ì¼)

```prisma
model Task {
  id          String     @id @default(cuid())
  studyId     String?    // ìŠ¤í„°ë”” ì—°ê²° (ì„ íƒ)
  userId      String
  title       String
  description String?    @db.Text
  status      TaskStatus @default(TODO)
  priority    Priority   @default(MEDIUM)
  dueDate     DateTime?
  
  completed   Boolean    @default(false)
  completedAt DateTime?
  
  createdAt   DateTime   @default(now())
}

enum TaskStatus {
  TODO         // í•  ì¼
  IN_PROGRESS  // ì§„í–‰ ì¤‘
  REVIEW       // ê²€í†  ì¤‘
  DONE         // ì™„ë£Œ
}

enum Priority {
  LOW          // ë‚®ìŒ
  MEDIUM       // ë³´í†µ
  HIGH         // ë†’ìŒ
  URGENT       // ê¸´ê¸‰
}
```

### 7. Event (ìº˜ë¦°ë” ì¼ì •)

```prisma
model Event {
  id          String   @id @default(cuid())
  studyId     String
  createdById String
  title       String
  date        DateTime @db.Date
  startTime   String
  endTime     String
  location    String?
  color       String   @default("#6366F1")
  
  createdAt   DateTime @default(now())
  
  @@index([studyId, date])
}
```

### 8. Notification (ì•Œë¦¼)

```prisma
model Notification {
  id         String           @id @default(cuid())
  userId     String
  type       NotificationType
  studyId    String?
  studyName  String?
  studyEmoji String?
  message    String
  data       Json?            // ì¶”ê°€ ë°ì´í„°
  
  isRead     Boolean          @default(false)
  createdAt  DateTime         @default(now())
  
  @@index([userId, isRead, createdAt])
}

enum NotificationType {
  JOIN_APPROVED   // ê°€ì… ìŠ¹ì¸
  NOTICE          // ìƒˆ ê³µì§€
  FILE            // íŒŒì¼ ì—…ë¡œë“œ
  EVENT           // ì¼ì •
  TASK            // ê³¼ì œ
  MEMBER          // ë©¤ë²„ ë³€ë™
  KICK            // ê°•í‡´
  CHAT            // ì±„íŒ…
}
```

---

## ê´€ë¦¬ì ì‹œìŠ¤í…œ ëª¨ë¸

### 9. Report (ì‹ ê³ )

```prisma
model Report {
  id          String       @id @default(cuid())
  reporterId  String
  targetType  TargetType   // USER, STUDY, MESSAGE
  targetId    String
  targetName  String?
  type        ReportType   // SPAM, HARASSMENT, etc.
  reason      String       @db.Text
  evidence    Json?
  
  status      ReportStatus @default(PENDING)
  priority    Priority     @default(MEDIUM)
  
  // ì²˜ë¦¬ ì •ë³´
  processedBy String?
  processedAt DateTime?
  resolution  String?      @db.Text
  
  createdAt   DateTime     @default(now())
}

enum TargetType { USER, STUDY, MESSAGE }
enum ReportType { SPAM, HARASSMENT, INAPPROPRIATE, COPYRIGHT, OTHER }
enum ReportStatus { PENDING, IN_PROGRESS, RESOLVED, REJECTED }
```

### 10. Sanction (ì œì¬)

```prisma
model Sanction {
  id              String       @id @default(cuid())
  userId          String
  adminId         String
  type            SanctionType
  reason          String       @db.Text
  duration        String?      // "1d", "7d", "30d", "permanent"
  expiresAt       DateTime?
  relatedReportId String?
  
  // í•´ì œ ì •ë³´
  isActive        Boolean      @default(true)
  unsuspendedBy   String?
  unsuspendReason String?
  unsuspendedAt   DateTime?
  
  createdAt       DateTime     @default(now())
}

enum SanctionType {
  WARNING           // ê²½ê³ 
  CHAT_BAN          // ì±„íŒ… ê¸ˆì§€
  STUDY_CREATE_BAN  // ìŠ¤í„°ë”” ìƒì„± ê¸ˆì§€
  FILE_UPLOAD_BAN   // íŒŒì¼ ì—…ë¡œë“œ ê¸ˆì§€
  RESTRICTION       // í™œë™ ì œí•œ
  SUSPENSION        // ê³„ì • ì •ì§€
  PERMANENT_BAN     // ì˜êµ¬ ì •ì§€
}
```

### 11. AdminLog (ê´€ë¦¬ì í™œë™ ë¡œê·¸)

```prisma
model AdminLog {
  id         String      @id @default(cuid())
  adminId    String
  action     AdminAction
  targetType String?     // "User", "Study", "Report"
  targetId   String?
  
  // ë³€ê²½ ë‚´ìš©
  before     Json?
  after      Json?
  reason     String?     @db.Text
  
  // ë©”íƒ€ ì •ë³´
  ipAddress  String?
  userAgent  String?
  
  createdAt  DateTime    @default(now())
}

enum AdminAction {
  USER_VIEW, USER_SEARCH, USER_WARN, USER_SUSPEND, ...
  STUDY_VIEW, STUDY_HIDE, STUDY_CLOSE, STUDY_DELETE, ...
  REPORT_VIEW, REPORT_ASSIGN, REPORT_RESOLVE, ...
  SETTINGS_VIEW, SETTINGS_UPDATE, ...
  ANALYTICS_VIEW, AUDIT_VIEW, ...
}
```

### 12. AdminRole (ê´€ë¦¬ì ì—­í• )

```prisma
model AdminRole {
  id          String        @id @default(cuid())
  userId      String        @unique
  role        AdminRoleType
  permissions Json          // ì„¸ë¶€ ê¶Œí•œ
  grantedBy   String
  grantedAt   DateTime      @default(now())
  expiresAt   DateTime?
}

enum AdminRoleType {
  VIEWER        // ì¡°íšŒë§Œ ê°€ëŠ¥
  MODERATOR     // ì½˜í…ì¸  ëª¨ë”ë ˆì´ì…˜
  ADMIN         // ì‚¬ìš©ì/ìŠ¤í„°ë”” ê´€ë¦¬
  SUPER_ADMIN   // ëª¨ë“  ê¶Œí•œ
}
```

---

## ê·¸ë£¹ ì‹œìŠ¤í…œ ëª¨ë¸

### 13. Group (ê·¸ë£¹)

```prisma
model Group {
  id           String  @id @default(cuid())
  name         String
  description  String? @db.Text
  category     String  @default("etc")
  imageUrl     String?
  
  // ì„¤ì •
  isPublic     Boolean @default(true)
  maxMembers   Int     @default(50)
  isRecruiting Boolean @default(true)
  
  createdBy    String
  deletedAt    DateTime?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // ê´€ê³„
  members      GroupMember[]
  invites      GroupInvite[]
}
```

---

## ì¸ë±ì‹± ì „ëµ

### ì£¼ìš” ì¸ë±ìŠ¤

```prisma
// ì‚¬ìš©ì ì¡°íšŒ ìµœì í™”
@@index([email])
@@index([status])
@@index([createdAt])
@@index([lastLoginAt])

// ìŠ¤í„°ë”” ê²€ìƒ‰ ìµœì í™”
@@index([category])
@@index([isPublic, isRecruiting])
@@index([ownerId])
@@index([rating])

// ìŠ¤í„°ë”” ë©¤ë²„ ì¡°íšŒ ìµœì í™”
@@index([userId])
@@index([status])
@@index([studyId, status])

// ë©”ì‹œì§€ ì¡°íšŒ ìµœì í™”
@@index([studyId, createdAt])

// ì•Œë¦¼ ì¡°íšŒ ìµœì í™”
@@index([userId, isRead, createdAt])

// ì‹ ê³  ì¡°íšŒ ìµœì í™”
@@index([status, priority, createdAt])
@@index([targetType, targetId])
```

---

## ëª¨ë¸ ê´€ê³„ ìš”ì•½

| ê´€ê³„ | ìœ í˜• | ì„¤ëª… |
|------|------|------|
| User â†’ Study | 1:N | í•œ ì‚¬ìš©ìê°€ ì—¬ëŸ¬ ìŠ¤í„°ë”” ì†Œìœ  |
| User â†” Study (via StudyMember) | N:M | ì‚¬ìš©ì-ìŠ¤í„°ë”” ë‹¤ëŒ€ë‹¤ ê´€ê³„ |
| Study â†’ Message | 1:N | ìŠ¤í„°ë””ì— ì—¬ëŸ¬ ë©”ì‹œì§€ |
| Study â†’ Notice | 1:N | ìŠ¤í„°ë””ì— ì—¬ëŸ¬ ê³µì§€ì‚¬í•­ |
| Study â†’ Event | 1:N | ìŠ¤í„°ë””ì— ì—¬ëŸ¬ ì¼ì • |
| Study â†’ File | 1:N | ìŠ¤í„°ë””ì— ì—¬ëŸ¬ íŒŒì¼ |
| User â†’ Task | 1:N | ì‚¬ìš©ìì˜ ê°œì¸ í• ì¼ |
| User â†’ Notification | 1:N | ì‚¬ìš©ìì˜ ì•Œë¦¼ |
| User â†’ Report | 1:N | ì‚¬ìš©ìì˜ ì‹ ê³  ë‚´ì—­ |
| User â†’ Sanction | 1:N | ì‚¬ìš©ìì˜ ì œì¬ ì´ë ¥ |
| Notice â†” File (via NoticeFile) | N:M | ê³µì§€-íŒŒì¼ ë‹¤ëŒ€ë‹¤ ê´€ê³„ |
| StudyTask â†” User (via StudyTaskAssignee) | N:M | ê³¼ì œ ë‹´ë‹¹ì ë‹¤ëŒ€ë‹¤ ê´€ê³„ |

