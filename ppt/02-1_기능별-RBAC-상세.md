# 2-1. 기능별 RBAC(역할 기반 접근 제어) 상세

## RBAC 개요

CoUp은 **3단계 역할 기반 접근 제어(RBAC)** 시스템을 적용합니다.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         CoUp RBAC 구조                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1️⃣ 시스템 역할 (UserRole)                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  USER (일반 사용자)  ───────────────  ADMIN (시스템 관리자)     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  2️⃣ 스터디 역할 (MemberRole)                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  OWNER (방장) ──── ADMIN (스터디 관리자) ──── MEMBER (멤버)     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  3️⃣ 관리자 역할 (AdminRoleType)                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  VIEWER ──── MODERATOR ──── ADMIN ──── SUPER_ADMIN             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 1. 시스템 역할 (UserRole)

### 역할 정의

| 역할 | 설명 | 대상 |
|------|------|------|
| **USER** | 일반 사용자 | 모든 가입 회원 (기본값) |
| **ADMIN** | 시스템 관리자 | 관리자 권한 부여된 사용자 |

### 시스템 역할별 접근 권한

| 기능 | USER | ADMIN |
|------|:----:|:-----:|
| 스터디 탐색/가입 | ✅ | ✅ |
| 스터디 생성 | ✅ | ✅ |
| 개인 할일 관리 | ✅ | ✅ |
| 프로필 관리 | ✅ | ✅ |
| 알림 관리 | ✅ | ✅ |
| **관리자 대시보드 접근** | ❌ | ✅ |
| **사용자 관리** | ❌ | ✅ |
| **스터디 관리 (전체)** | ❌ | ✅ |
| **신고 처리** | ❌ | ✅ |
| **시스템 설정** | ❌ | ✅ |

---

## 2. 스터디 역할 (MemberRole)

### 역할 정의

| 역할 | 설명 | 부여 방식 |
|------|------|----------|
| **OWNER** | 스터디 방장 (생성자) | 스터디 생성 시 자동 부여 |
| **ADMIN** | 스터디 관리자 | OWNER가 임명 |
| **MEMBER** | 일반 멤버 | 가입 승인 시 부여 (기본값) |

### 역할 계층 구조

```
👑 OWNER (Level 3)
    │
    ├── 스터디 삭제
    ├── 관리자 임명/해제
    ├── 모든 ADMIN 권한 포함
    │
    ▼
⭐ ADMIN (Level 2)
    │
    ├── 멤버 강퇴/승인
    ├── 공지사항 관리
    ├── 일정 관리
    ├── 과제 관리
    ├── 스터디 설정 일부 변경
    ├── 모든 MEMBER 권한 포함
    │
    ▼
👤 MEMBER (Level 1)
    │
    ├── 채팅 참여
    ├── 화상 통화 참여
    ├── 파일 업로드/다운로드
    ├── 일정 확인
    ├── 공지사항 확인
    └── 과제 확인/완료 처리
```

---

## 3. 기능별 스터디 역할 권한 매트릭스

### 스터디 관리

| 기능 | OWNER | ADMIN | MEMBER | 비고 |
|------|:-----:|:-----:|:------:|------|
| 스터디 정보 조회 | ✅ | ✅ | ✅ | 모든 멤버 |
| 스터디 기본 설정 변경 | ✅ | ✅ | ❌ | 이름, 설명, 이모지 |
| 스터디 모집 상태 변경 | ✅ | ✅ | ❌ | 모집중/마감 |
| 스터디 공개 설정 변경 | ✅ | ❌ | ❌ | 공개/비공개 |
| 스터디 삭제 | ✅ | ❌ | ❌ | 방장만 가능 |
| 스터디 탈퇴 | ❌ | ✅ | ✅ | 방장은 탈퇴 불가 |

### 멤버 관리

| 기능 | OWNER | ADMIN | MEMBER | 비고 |
|------|:-----:|:-----:|:------:|------|
| 멤버 목록 조회 | ✅ | ✅ | ✅ | 모든 멤버 |
| 가입 신청 목록 조회 | ✅ | ✅ | ❌ | |
| 가입 승인/거부 | ✅ | ✅ | ❌ | |
| 멤버 강퇴 | ✅ | ✅ | ❌ | ADMIN은 MEMBER만 강퇴 가능 |
| 관리자 임명 | ✅ | ❌ | ❌ | |
| 관리자 해제 | ✅ | ❌ | ❌ | |
| 방장 위임 | ✅ | ❌ | ❌ | |

### 채팅

| 기능 | OWNER | ADMIN | MEMBER | 비고 |
|------|:-----:|:-----:|:------:|------|
| 메시지 전송 | ✅ | ✅ | ✅ | |
| 메시지 조회 | ✅ | ✅ | ✅ | |
| 파일 첨부 | ✅ | ✅ | ✅ | |
| 본인 메시지 삭제 | ✅ | ✅ | ✅ | |
| 타인 메시지 삭제 | ✅ | ✅ | ❌ | 관리 목적 |

### 화상 통화

| 기능 | OWNER | ADMIN | MEMBER | 비고 |
|------|:-----:|:-----:|:------:|------|
| 통화 참여 | ✅ | ✅ | ✅ | |
| 화면 공유 | ✅ | ✅ | ✅ | |
| 참여자 음소거 (호스트) | ✅ | ✅ | ❌ | 관리 기능 |
| 참여자 강제 퇴장 | ✅ | ✅ | ❌ | 관리 기능 |

### 공지사항

| 기능 | OWNER | ADMIN | MEMBER | 비고 |
|------|:-----:|:-----:|:------:|------|
| 공지 조회 | ✅ | ✅ | ✅ | |
| 공지 작성 | ✅ | ✅ | ❌ | |
| 공지 수정 | ✅ | ✅ | ❌ | 본인 작성 공지 |
| 공지 삭제 | ✅ | ✅ | ❌ | OWNER는 모든 공지 삭제 가능 |
| 공지 고정/해제 | ✅ | ✅ | ❌ | |
| 중요 표시 | ✅ | ✅ | ❌ | |

### 캘린더 (일정)

| 기능 | OWNER | ADMIN | MEMBER | 비고 |
|------|:-----:|:-----:|:------:|------|
| 일정 조회 | ✅ | ✅ | ✅ | |
| 일정 생성 | ✅ | ✅ | ❌ | |
| 일정 수정 | ✅ | ✅ | ❌ | |
| 일정 삭제 | ✅ | ✅ | ❌ | |

### 파일 공유

| 기능 | OWNER | ADMIN | MEMBER | 비고 |
|------|:-----:|:-----:|:------:|------|
| 파일 조회 | ✅ | ✅ | ✅ | |
| 파일 다운로드 | ✅ | ✅ | ✅ | |
| 파일 업로드 | ✅ | ✅ | ✅ | |
| 본인 파일 삭제 | ✅ | ✅ | ✅ | |
| 타인 파일 삭제 | ✅ | ✅ | ❌ | 관리 목적 |

### 스터디 할일 (과제)

| 기능 | OWNER | ADMIN | MEMBER | 비고 |
|------|:-----:|:-----:|:------:|------|
| 과제 조회 | ✅ | ✅ | ✅ | |
| 과제 생성 | ✅ | ✅ | ❌ | |
| 과제 수정 | ✅ | ✅ | ❌ | |
| 과제 삭제 | ✅ | ✅ | ❌ | |
| 담당자 지정 | ✅ | ✅ | ❌ | |
| 본인 과제 완료 처리 | ✅ | ✅ | ✅ | 배정된 과제만 |

---

## 4. 관리자 역할 (AdminRoleType)

### 역할 정의

| 역할 | 설명 | 주요 권한 |
|------|------|----------|
| **VIEWER** | 조회 전용 | 통계, 로그 조회만 가능 |
| **MODERATOR** | 모더레이터 | 콘텐츠 모더레이션, 신고 처리 |
| **ADMIN** | 관리자 | 사용자/스터디 관리, 제재 조치 |
| **SUPER_ADMIN** | 최고 관리자 | 모든 권한, 시스템 설정, 관리자 관리 |

### 관리자 역할별 권한 매트릭스

| 기능 | VIEWER | MODERATOR | ADMIN | SUPER_ADMIN |
|------|:------:|:---------:|:-----:|:-----------:|
| **대시보드** |||||
| 통계 조회 | ✅ | ✅ | ✅ | ✅ |
| 최근 활동 조회 | ✅ | ✅ | ✅ | ✅ |
| **사용자 관리** |||||
| 사용자 목록 조회 | ✅ | ✅ | ✅ | ✅ |
| 사용자 상세 조회 | ✅ | ✅ | ✅ | ✅ |
| 사용자 경고 | ❌ | ✅ | ✅ | ✅ |
| 사용자 정지 | ❌ | ❌ | ✅ | ✅ |
| 사용자 영구 정지 | ❌ | ❌ | ❌ | ✅ |
| 정지 해제 | ❌ | ❌ | ✅ | ✅ |
| 사용자 삭제 | ❌ | ❌ | ❌ | ✅ |
| **스터디 관리** |||||
| 스터디 목록 조회 | ✅ | ✅ | ✅ | ✅ |
| 스터디 상세 조회 | ✅ | ✅ | ✅ | ✅ |
| 스터디 숨김 처리 | ❌ | ✅ | ✅ | ✅ |
| 스터디 종료 | ❌ | ❌ | ✅ | ✅ |
| 스터디 삭제 | ❌ | ❌ | ❌ | ✅ |
| **신고 처리** |||||
| 신고 목록 조회 | ✅ | ✅ | ✅ | ✅ |
| 신고 상세 조회 | ✅ | ✅ | ✅ | ✅ |
| 신고 처리 (해결/기각) | ❌ | ✅ | ✅ | ✅ |
| 제재 조치 | ❌ | ✅ | ✅ | ✅ |
| **시스템 설정** |||||
| 설정 조회 | ❌ | ❌ | ❌ | ✅ |
| 설정 변경 | ❌ | ❌ | ❌ | ✅ |
| 캐시 초기화 | ❌ | ❌ | ❌ | ✅ |
| **관리자 관리** |||||
| 관리자 목록 조회 | ❌ | ❌ | ✅ | ✅ |
| 관리자 임명 | ❌ | ❌ | ❌ | ✅ |
| 관리자 해제 | ❌ | ❌ | ❌ | ✅ |
| **감사 로그** |||||
| 로그 조회 | ✅ | ✅ | ✅ | ✅ |
| 로그 내보내기 | ❌ | ❌ | ✅ | ✅ |

---

## 5. 제재 유형 (SanctionType)

관리자가 사용자에게 적용할 수 있는 제재 유형:

| 제재 | 설명 | 적용 권한 | 기간 |
|------|------|----------|------|
| **WARNING** | 경고 | MODERATOR+ | - |
| **CHAT_BAN** | 채팅 금지 | MODERATOR+ | 1일~30일 |
| **STUDY_CREATE_BAN** | 스터디 생성 금지 | ADMIN+ | 1일~30일 |
| **FILE_UPLOAD_BAN** | 파일 업로드 금지 | MODERATOR+ | 1일~30일 |
| **RESTRICTION** | 활동 제한 | ADMIN+ | 1일~30일 |
| **SUSPENSION** | 계정 정지 | ADMIN+ | 1일~30일 |
| **PERMANENT_BAN** | 영구 정지 | SUPER_ADMIN | 영구 |

---

## 6. 멤버 상태 (MemberStatus)

스터디 멤버의 상태값:

| 상태 | 설명 | 권한 |
|------|------|------|
| **PENDING** | 가입 대기 중 | 접근 불가 |
| **ACTIVE** | 활성 멤버 | 역할에 따른 권한 |
| **KICKED** | 강퇴됨 | 접근 불가, 재가입 불가 |
| **LEFT** | 탈퇴함 | 접근 불가, 재가입 가능 |

---

## 7. 권한 검증 흐름

### API 요청 시 권한 검증

```
┌─────────────┐
│  API 요청   │
└──────┬──────┘
       │
       ▼
┌─────────────────────┐
│ 1. 인증 확인        │
│ (NextAuth Session)  │
└──────┬──────────────┘
       │ 인증됨
       ▼
┌─────────────────────┐
│ 2. 시스템 역할 확인  │
│ (USER / ADMIN)      │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 3. 관리자 API인 경우        │
│ → AdminRole 권한 확인       │
│                             │
│ 스터디 API인 경우           │
│ → MemberRole 권한 확인      │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────┐
│ 4. 권한 충족 시     │
│    요청 처리        │
│                     │
│ 권한 미충족 시      │
│    403 Forbidden    │
└─────────────────────┘
```

### 권한 검증 코드 예시

```javascript
// 스터디 멤버 권한 검사
export async function requireStudyMember(studyId, minRole = 'MEMBER') {
  const session = await getServerSession(authOptions)
  
  if (!session) {
    return { error: "인증이 필요합니다", status: 401 }
  }
  
  const member = await prisma.studyMember.findUnique({
    where: {
      studyId_userId: { studyId, userId: session.user.id }
    }
  })
  
  if (!member || member.status !== 'ACTIVE') {
    return { error: "스터디 멤버가 아닙니다", status: 403 }
  }
  
  // 역할 계층 확인
  const roleHierarchy = { OWNER: 3, ADMIN: 2, MEMBER: 1 }
  if (roleHierarchy[member.role] < roleHierarchy[minRole]) {
    return { error: "권한이 부족합니다", status: 403 }
  }
  
  return { session, member }
}

// 사용 예시
export async function DELETE(request, { params }) {
  const { studyId } = params
  
  // OWNER만 스터디 삭제 가능
  const auth = await requireStudyMember(studyId, 'OWNER')
  if (auth.error) {
    return NextResponse.json({ error: auth.error }, { status: auth.status })
  }
  
  // 스터디 삭제 로직...
}
```

---

## 8. RBAC 적용 API 엔드포인트

### 스터디 관련 API

| 엔드포인트 | 메서드 | 필요 권한 |
|-----------|--------|----------|
| `/api/studies` | GET | 인증된 사용자 |
| `/api/studies` | POST | 인증된 사용자 |
| `/api/studies/[id]` | GET | 인증된 사용자 |
| `/api/studies/[id]` | PUT | OWNER, ADMIN |
| `/api/studies/[id]` | DELETE | OWNER |
| `/api/studies/[id]/members` | GET | MEMBER+ |
| `/api/studies/[id]/members` | POST | ADMIN+ (가입 승인) |
| `/api/studies/[id]/members/[userId]` | DELETE | ADMIN+ (강퇴) |

### 채팅 API

| 엔드포인트 | 메서드 | 필요 권한 |
|-----------|--------|----------|
| `/api/my-studies/[id]/messages` | GET | MEMBER+ |
| `/api/my-studies/[id]/messages` | POST | MEMBER+ |
| `/api/my-studies/[id]/messages/[msgId]` | DELETE | MEMBER+(본인), ADMIN+(모두) |

### 공지사항 API

| 엔드포인트 | 메서드 | 필요 권한 |
|-----------|--------|----------|
| `/api/my-studies/[id]/notices` | GET | MEMBER+ |
| `/api/my-studies/[id]/notices` | POST | ADMIN+ |
| `/api/my-studies/[id]/notices/[noticeId]` | PUT | ADMIN+ |
| `/api/my-studies/[id]/notices/[noticeId]` | DELETE | ADMIN+ |

### 관리자 API

| 엔드포인트 | 메서드 | 필요 권한 |
|-----------|--------|----------|
| `/api/admin/stats` | GET | VIEWER+ |
| `/api/admin/users` | GET | VIEWER+ |
| `/api/admin/users/[id]/warn` | POST | MODERATOR+ |
| `/api/admin/users/[id]/suspend` | POST | ADMIN+ |
| `/api/admin/users/[id]/delete` | DELETE | SUPER_ADMIN |
| `/api/admin/reports` | GET | VIEWER+ |
| `/api/admin/reports/[id]/resolve` | POST | MODERATOR+ |
| `/api/admin/settings` | GET/PUT | SUPER_ADMIN |

---

## 요약

CoUp의 RBAC 시스템은 **3단계 역할 구조**로 세밀한 권한 관리를 제공합니다:

1. **시스템 역할**: 일반 사용자와 관리자 구분
2. **스터디 역할**: 스터디 내 OWNER/ADMIN/MEMBER 계층
3. **관리자 역할**: 관리자 권한의 4단계 세분화

이를 통해:
- ✅ 불필요한 권한 노출 방지
- ✅ 역할별 명확한 책임 분리
- ✅ 유연한 권한 위임 가능
- ✅ 감사 추적 용이

