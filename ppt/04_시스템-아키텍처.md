# 4. 시스템 아키텍처

## 전체 시스템 아키텍처

```
┌───────────────────────────────────────────────────────────────────────────────┐
│                              Client (Browser)                                  │
│                       React 19 + Next.js 16 (SSR/CSR)                         │
│  ┌────────────────┐ ┌────────────────┐ ┌────────────────┐ ┌────────────────┐  │
│  │   Dashboard    │ │    Studies     │ │     Chat       │ │   Video Call   │  │
│  │   Component    │ │   Component    │ │   Component    │ │   Component    │  │
│  └────────────────┘ └────────────────┘ └────────────────┘ └────────────────┘  │
│                                     │                                          │
│  ┌──────────────────────────────────┴────────────────────────────────────┐    │
│  │                        TanStack Query (캐싱)                           │    │
│  └────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────┬──────────────────────────┬──────────────────┘
                                  │ HTTPS (REST API)         │ WebSocket
                                  │                          │ (Socket.IO)
                                  ▼                          ▼
┌──────────────────────────────────────┐    ┌──────────────────────────────────┐
│          Next.js Application         │    │       Signaling Server           │
│         (Vercel / Docker)            │    │      (Express.js + Socket.IO)    │
│                                      │    │                                  │
│  ┌─────────────┐  ┌─────────────┐   │    │  ┌───────────────────────────┐   │
│  │   Frontend  │  │  API Routes │   │    │  │     Event Handlers        │   │
│  │  (SSR/CSR)  │  │  (RESTful)  │   │    │  ├───────────────────────────┤   │
│  └─────────────┘  └─────────────┘   │    │  │ • video.js (화상통화)     │   │
│                          │          │    │  │ • chat.js (채팅)          │   │
│  ┌─────────────┐  ┌─────────────┐   │    │  │ • presence.js (온라인)    │   │
│  │  NextAuth   │  │   Prisma    │   │    │  └───────────────────────────┘   │
│  │   (인증)    │  │   (ORM)     │   │    │                 │                │
│  └─────────────┘  └─────────────┘   │    │  ┌───────────────────────────┐   │
│                          │          │    │  │    Redis Adapter          │   │
└──────────────────────────┼──────────┘    │  │  (다중 서버 지원)         │   │
                           │               │  └─────────────┬─────────────┘   │
                           │               └────────────────┼─────────────────┘
                           │                                │
                           ▼                                ▼
┌──────────────────────────────────────┐    ┌──────────────────────────────────┐
│           PostgreSQL 15               │    │            Redis 7               │
│        (Primary Database)            │    │      (Pub/Sub & Cache)           │
│                                      │    │                                  │
│  ┌────────────────────────────────┐  │    │  ┌───────────────────────────┐   │
│  │         Data Models            │  │    │  │        기능               │   │
│  ├────────────────────────────────┤  │    │  ├───────────────────────────┤   │
│  │ • User (사용자)                │  │    │  │ • Socket.IO Pub/Sub       │   │
│  │ • Study (스터디)               │  │    │  │ • 세션 캐시               │   │
│  │ • StudyMember (멤버)           │  │    │  │ • 메시지 동기화           │   │
│  │ • Message (메시지)             │  │    │  │ • 실시간 데이터           │   │
│  │ • Notification (알림)          │  │    │  └───────────────────────────┘   │
│  │ • Task (할일)                  │  │    │                                  │
│  │ • Event (일정)                 │  │    │                                  │
│  │ • File (파일)                  │  │    │                                  │
│  │ • Report (신고)                │  │    │                                  │
│  │ • AdminLog (관리자 로그)       │  │    │                                  │
│  │ • 등 15개+ 모델                │  │    │                                  │
│  └────────────────────────────────┘  │    │                                  │
└──────────────────────────────────────┘    └──────────────────────────────────┘
```

---

## 핵심 설계 원칙

### 1. 분리형 아키텍처 (Separated Architecture)

```
┌─────────────────────────────────────────────────────────────┐
│                     분리형 아키텍처                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────────┐         ┌─────────────────┐          │
│   │   Next.js App   │         │ Signaling Server│          │
│   │  (HTTP/REST)    │         │   (WebSocket)   │          │
│   │                 │         │                 │          │
│   │  • 페이지 렌더링 │         │  • 실시간 채팅  │          │
│   │  • API 처리     │         │  • 화상 통화    │          │
│   │  • 인증/인가    │         │  • 알림         │          │
│   │  • DB 접근      │         │  • 온라인 상태  │          │
│   └─────────────────┘         └─────────────────┘          │
│                                                             │
│   장점:                                                    │
│   • 독립적 확장 가능                                        │
│   • 장애 격리                                              │
│   • 기술 스택 독립성                                        │
│   • 유지보수 용이                                          │
└─────────────────────────────────────────────────────────────┘
```

### 2. 마이크로서비스 패턴

| 서비스 | 역할 | 포트 | 기술 |
|--------|------|------|------|
| **Next.js App** | 메인 애플리케이션 | 3000 | Next.js 16 |
| **Signaling Server** | 실시간 통신 | 4000 | Express + Socket.IO |
| **PostgreSQL** | 데이터 저장 | 5432 | PostgreSQL 15 |
| **Redis** | 캐시/Pub-Sub | 6379 | Redis 7 |

### 3. 수평 확장 지원

```
┌─────────────────────────────────────────────────────────────────────┐
│                    수평 확장 아키텍처                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│                      ┌──────────────┐                               │
│                      │ Load Balancer│                               │
│                      └──────┬───────┘                               │
│              ┌──────────────┼──────────────┐                        │
│              ▼              ▼              ▼                        │
│   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                  │
│   │ Signaling   │ │ Signaling   │ │ Signaling   │                  │
│   │ Server #1   │ │ Server #2   │ │ Server #N   │                  │
│   └──────┬──────┘ └──────┬──────┘ └──────┬──────┘                  │
│          │               │               │                          │
│          └───────────────┼───────────────┘                          │
│                          ▼                                          │
│                 ┌─────────────────┐                                 │
│                 │ Redis Pub/Sub   │  ← 메시지 동기화                │
│                 │ (Adapter)       │                                 │
│                 └─────────────────┘                                 │
│                                                                     │
│   장점: 트래픽 증가 시 시그널링 서버 인스턴스 추가로 대응 가능     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 데이터 흐름

### 1. 일반 API 요청 흐름

```
┌──────────┐     ┌──────────────┐     ┌──────────────┐     ┌────────────┐
│  Client  │────>│  Next.js     │────>│   Prisma     │────>│ PostgreSQL │
│          │     │  API Route   │     │   Client     │     │            │
└──────────┘     └──────────────┘     └──────────────┘     └────────────┘
     │                  │                    │                    │
     │    HTTP Request  │    ORM Query       │    SQL Query       │
     │                  │                    │                    │
     │<─────────────────│<───────────────────│<───────────────────│
     │   JSON Response  │   Prisma Result    │   Query Result     │
```

### 2. 실시간 채팅 흐름

```
┌──────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────┐
│ Client A │     │  Signaling   │     │    Redis     │     │ Client B │
│          │     │   Server     │     │   Pub/Sub    │     │          │
└────┬─────┘     └──────┬───────┘     └──────┬───────┘     └────┬─────┘
     │                  │                    │                  │
     │ 1. Send Message  │                    │                  │
     ├─────────────────>│                    │                  │
     │                  │ 2. Publish         │                  │
     │                  ├───────────────────>│                  │
     │                  │                    │ 3. Subscribe     │
     │                  │                    ├────────────────>│
     │                  │                    │                  │
     │                  │ 4. Broadcast       │<─────────────────│
     │                  │<───────────────────│                  │
     │                  │                    │  5. New Message  │
     │                  ├────────────────────┼─────────────────>│
```

### 3. 화상 통화 시그널링 흐름

```
┌──────────┐              ┌──────────────┐              ┌──────────┐
│ Client A │              │  Signaling   │              │ Client B │
│ (Caller) │              │    Server    │              │ (Callee) │
└────┬─────┘              └──────┬───────┘              └────┬─────┘
     │                           │                           │
     │ 1. video:join-room        │                           │
     ├──────────────────────────>│                           │
     │                           │ 2. video:join-room        │
     │                           │<──────────────────────────│
     │                           │                           │
     │ 3. video:user-joined      │                           │
     │<──────────────────────────│                           │
     │                           │                           │
     │ 4. video:offer            │                           │
     ├──────────────────────────>│                           │
     │                           │ 5. video:offer            │
     │                           ├──────────────────────────>│
     │                           │                           │
     │                           │ 6. video:answer           │
     │                           │<──────────────────────────│
     │ 7. video:answer           │                           │
     │<──────────────────────────│                           │
     │                           │                           │
     │ 8. video:ice-candidate    │                           │
     │<─────────────────────────>│<─────────────────────────>│
     │                           │                           │
     │                                                       │
     │ ═══════════ P2P WebRTC Connection ═══════════════════>│
     │                (Direct Video/Audio)                   │
```

---

## 인증/인가 아키텍처

### NextAuth.js 기반 인증 흐름

```
┌──────────────────────────────────────────────────────────────────────┐
│                         인증 흐름                                    │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌─────────────┐                                                     │
│  │  로그인 폼  │                                                     │
│  └──────┬──────┘                                                     │
│         │                                                            │
│         ▼                                                            │
│  ┌──────────────────────────────────────────────────────────┐       │
│  │                  NextAuth.js                              │       │
│  │  ┌───────────────┐  ┌───────────────┐  ┌──────────────┐  │       │
│  │  │  Credentials  │  │    Google     │  │   GitHub     │  │       │
│  │  │   Provider    │  │   Provider    │  │  Provider    │  │       │
│  │  └───────────────┘  └───────────────┘  └──────────────┘  │       │
│  └────────────────────────────┬─────────────────────────────┘       │
│                               │                                      │
│                               ▼                                      │
│  ┌──────────────────────────────────────────────────────────┐       │
│  │                    JWT Token 생성                         │       │
│  │  • userId, email, name, role 포함                        │       │
│  │  • HttpOnly Cookie로 저장                                 │       │
│  └──────────────────────────────────────────────────────────┘       │
│                               │                                      │
│                               ▼                                      │
│  ┌──────────────────────────────────────────────────────────┐       │
│  │                    세션 검증                              │       │
│  │  • API 요청 시 토큰 검증                                  │       │
│  │  • middleware.js에서 인증 필수 경로 보호                  │       │
│  │  • requireAuth() 헬퍼로 API 보호                         │       │
│  └──────────────────────────────────────────────────────────┘       │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

### 역할 기반 접근 제어 (RBAC)

```
┌──────────────────────────────────────────────────────────────────────┐
│                    역할 기반 권한 체계                               │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   시스템 역할 (UserRole)                                            │
│   ┌────────────┐     ┌────────────┐                                 │
│   │    USER    │     │   ADMIN    │                                 │
│   │  (일반)    │     │ (관리자)   │                                 │
│   └────────────┘     └────────────┘                                 │
│                                                                      │
│   스터디 역할 (MemberRole)                                          │
│   ┌────────────┐     ┌────────────┐     ┌────────────┐             │
│   │   OWNER    │     │   ADMIN    │     │   MEMBER   │             │
│   │   (방장)   │     │ (관리자)   │     │  (멤버)    │             │
│   ├────────────┤     ├────────────┤     ├────────────┤             │
│   │ • 스터디   │     │ • 멤버 관리│     │ • 기본     │             │
│   │   삭제     │     │ • 공지 작성│     │   참여     │             │
│   │ • 관리자   │     │ • 일정 관리│     │ • 채팅     │             │
│   │   임명     │     │ • 과제 관리│     │ • 파일     │             │
│   │ • 모든권한 │     │            │     │   다운로드 │             │
│   └────────────┘     └────────────┘     └────────────┘             │
│                                                                      │
│   관리자 역할 (AdminRoleType)                                       │
│   ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────────┐      │
│   │  VIEWER   │ │ MODERATOR │ │   ADMIN   │ │ SUPER_ADMIN   │      │
│   │ (조회)    │ │ (모더)    │ │  (관리)   │ │ (최고관리자)  │      │
│   └───────────┘ └───────────┘ └───────────┘ └───────────────┘      │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

---

## 보안 아키텍처

```
┌──────────────────────────────────────────────────────────────────────┐
│                         보안 계층                                    │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   1. 네트워크 계층                                                   │
│   ┌──────────────────────────────────────────────────────────┐      │
│   │  • HTTPS (TLS 암호화)                                     │      │
│   │  • CORS 정책 (허용된 Origin만 접근)                       │      │
│   │  • Rate Limiting (과도한 요청 방지)                       │      │
│   └──────────────────────────────────────────────────────────┘      │
│                                                                      │
│   2. 인증 계층                                                       │
│   ┌──────────────────────────────────────────────────────────┐      │
│   │  • JWT 토큰 기반 인증                                     │      │
│   │  • HttpOnly Cookie (XSS 방지)                            │      │
│   │  • bcryptjs 비밀번호 해싱 (Salt 포함)                     │      │
│   └──────────────────────────────────────────────────────────┘      │
│                                                                      │
│   3. 인가 계층                                                       │
│   ┌──────────────────────────────────────────────────────────┐      │
│   │  • 역할 기반 접근 제어 (RBAC)                             │      │
│   │  • middleware.js 경로 보호                                │      │
│   │  • API별 권한 검증                                        │      │
│   └──────────────────────────────────────────────────────────┘      │
│                                                                      │
│   4. 데이터 계층                                                     │
│   ┌──────────────────────────────────────────────────────────┐      │
│   │  • Zod 입력 검증                                          │      │
│   │  • SQL Injection 방지 (Prisma ORM)                        │      │
│   │  • XSS 방지 (sanitize-html)                              │      │
│   └──────────────────────────────────────────────────────────┘      │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

---

## 배포 아키텍처

### Docker Compose 구성

```yaml
# 전체 서비스 오케스트레이션
services:
  nextjs:        # 메인 앱 (포트 3000)
  signaling:     # 시그널링 서버 (포트 4000)
  postgres:      # 데이터베이스 (포트 5432)
  redis:         # 캐시/Pub-Sub (포트 6379)
```

### 배포 환경 구성

```
┌──────────────────────────────────────────────────────────────────────┐
│                        배포 환경                                     │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   개발 환경 (Development)                                            │
│   ┌──────────────────────────────────────────────────────────┐      │
│   │  • Docker Compose로 전체 서비스 로컬 실행                 │      │
│   │  • Hot Reload 활성화                                      │      │
│   │  • 개발용 시드 데이터                                     │      │
│   └──────────────────────────────────────────────────────────┘      │
│                                                                      │
│   프로덕션 환경 (Production) - 계획                                  │
│   ┌──────────────────────────────────────────────────────────┐      │
│   │  • Vercel: Next.js 앱 배포                                │      │
│   │  • AWS ECS/Fargate: 시그널링 서버                         │      │
│   │  • AWS RDS: PostgreSQL                                    │      │
│   │  • AWS ElastiCache: Redis                                 │      │
│   │  • AWS S3: 파일 스토리지 (계획)                           │      │
│   └──────────────────────────────────────────────────────────┘      │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

